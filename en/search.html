<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Search Results | Click & Go</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{--brand:#0aa297;--card:#0aa29733;--gold:#d4a017;--muted:#666}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .main-title{font-size:36px;margin:8px 0 4px}
    .muted{color:var(--muted)} .nowrap{white-space:nowrap}
    .bar{display:flex;gap:10px;align-items:center;overflow:auto;padding:8px 0;margin:12px 0 16px}
    .chip{flex:0 0 auto;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;cursor:pointer}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:980px){.cards{grid-template-columns:repeat(2,1fr)}}@media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07);border:2px solid var(--card)}
    .card img{width:100%;height:210px;object-fit:cover;display:block;background:#f4f4f4}
    .card-body{padding:14px;display:flex;flex-direction:column;min-height:180px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .stars{display:inline-flex;gap:2px;vertical-align:middle}.star{width:16px;height:16px}.star svg{width:100%;height:100%;fill:var(--gold)}
    .price{font-weight:700;margin-top:8px}.score{color:#c62828}
    .cta-wrap{display:flex;justify-content:center;margin:28px 0}
  </style>
</head>
<body>
<header class="site-header">
  <div class="inner container" style="display:flex;justify-content:space-between;align-items:center">
    <a href="/en/index.html" class="brand" style="display:flex;align-items:center;gap:10px"><img src="/logo.png" width="40" height="40" alt="Click & Go"><strong>Click & Go</strong></a>
    <nav><a href="/index.html">ไทย</a></nav>
  </div>
</header>

<main class="container">
  <h1 id="title" class="main-title">Search results</h1>
  <p class="muted" id="subtitle"></p>

  <div class="bar" role="toolbar" aria-label="Filters">
    <button id="chipSort" class="chip"><span>Sort</span><small id="chipSortV">Recommended</small></button>
    <button id="chipStars" class="chip"><span>Stars</span><small id="chipStarsV">Any</small></button>
    <button id="chipPrice" class="chip"><span>Price</span><small id="chipPriceV">$0 – $200,000</small></button>
    <button id="chipScore" class="chip"><span>Review score</span><small id="chipScoreV">Any</small></button>
    <button id="chipApply" class="chip" style="background:var(--brand);color:#fff;border-color:var(--brand)">Apply</button>
  </div>

  <section id="grid" class="cards" aria-live="polite"></section>

  <div class="cta-wrap">
    <a id="partnerMore" class="btn" href="#" target="_blank" rel="nofollow noopener">See more on our partner</a>
  </div>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const state = {
    q: params.get('q') || '',
    cityId: params.get('cityId') || params.get('cityid') || '',
    hid: params.get('hid') || params.get('hotelId') || '',
    city: params.get('city') || '',
    country: params.get('country') || '',
    checkin: params.get('checkin'),
    checkout: params.get('checkout'),
    rooms: +(params.get('rooms') || 1),
    adults: +(params.get('adults') || 2),
    children: +(params.get('children') || 0),
    lang: (params.get('lang') || 'en-us').toLowerCase(),
    currency: 'THB',
    sort: params.get('sort') || 'rec',
    starsMin: +(params.get('starsMin') || 0),
    scoreMin: +(params.get('scoreMin') || 0),
    priceMin: +(params.get('priceMin') || 0),
    priceMax: +(params.get('priceMax') || 200000)
  };

  function setSubtitle(){
    const ci=(state.checkin||'').replaceAll('-','/'), co=(state.checkout||'').replaceAll('-','/');
    const place=state.city || state.q || '—';
    $('#subtitle').innerHTML = `<span class="nowrap">${place} | Dates: ${ci} → ${co}</span><br><span class="nowrap">Guests: ${state.adults} adults, ${state.children} children, ${state.rooms} rooms</span>`;
  }
  setSubtitle();

  function fmt(n, cur='THB'){ if(n==null) return '-'; const zero=new Set(['THB','JPY','IDR','KRW','VND']).has(cur.toUpperCase()); const v=zero?Math.round(n):n; try{ return new Intl.NumberFormat('en-US',{maximumFractionDigits:zero?0:2}).format(v); }catch(_){ return String(v); } }
  const esc = s => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

  function partnerUrl(){
    const lang = state.lang || 'en-us';
    const base = `https://www.agoda.com/${lang}/partners/partnersearch.aspx`;
    const sp = new URLSearchParams({
      cid:'1949420',
      ...(state.hid?{hid:String(state.hid)}:{city:String(state.cityId)}),
      checkin:state.checkin||'', checkout:state.checkout||'',
      rooms:String(state.rooms||1), adults:String(state.adults||2), children:String(state.children||0),
      currency:state.currency||'THB', pcs:'1', noapp:'1', utm_source:'clickandgo', utm_medium:'affiliate'
    });
    return `${base}?${sp.toString()}`;
  }
  const setPartner = () => $('#partnerMore').setAttribute('href', partnerUrl());

  async function fetchJson(u){ try{const r=await fetch(u,{cache:'no-store'}); return await r.json(); }catch(_){ return {ok:false}; } }

  async function resolveCityIfNeeded(){
    if ((state.cityId || state.hid) || !state.q) return;
    try{
      const r=await fetch(`/api/city-suggest?q=${encodeURIComponent(state.q)}&lang=en-us&limit=1`,{cache:'no-store'});
      const d=await r.json();
      if(d&&d.ok&&d.items?.[0]?.city_id){ state.cityId=String(d.items[0].city_id); state.city=d.items[0].label||state.city; }
    }catch(_){}
  }

  function render(list){
    if(!list.length){ $('#grid').innerHTML = `<p class="muted">No results match your search.</p>`; return; }
    const readName = h => h.name || h.hotelName || h.title || h.label || '—';
    const readImg  = h => h.thumbnail || h.image || h.img || h.photo || '';
    const readUrl  = h => h.url || h.link || h.deeplink || '#';
    const readStars= h => h.rating ?? h.stars ?? h.star ?? 0;
    const readScore= h => h.reviewScore ?? h.score ?? h.review_score ?? null;
    const readCurr = h => h.currency || 'THB';
    const readPrice= h => (h.price ?? h.minPrice ?? h.min_price ?? null);

    const starIcons = n => {
      const c=Math.max(0,Math.min(5,Math.round(n||0)));
      return `<span class="stars" aria-label="${c} stars">` +
        Array.from({length:c}).map(()=>`<span class="star"><svg viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>`).join('')+
      `</span>`;
    };

    $('#grid').innerHTML = list.map(h=>{
      const name=esc(readName(h)), img=esc(readImg(h)), url=esc(readUrl(h));
      const stars=readStars(h), score=readScore(h), price=readPrice(h), cur=readCurr(h);
      return `
        <article class="card">
          <img src="${img}" alt="${name}">
          <div class="card-body">
            <h3 style="font-size:18px;margin:0 0 6px">${name}</h3>
            <div class="muted" style="font-size:13px">${starIcons(stars)}${score!=null?`&nbsp;·&nbsp;<span class="score">Score ${score}</span>`:''}</div>
            <div class="price">${price!=null?fmt(price,cur):'-'} ${cur}</div>
            <div style="margin-top:auto;display:flex;justify-content:flex-end"><a class="btn" href="${url}" target="_blank" rel="nofollow noopener">See offer</a></div>
          </div>
        </article>`;
    }).join('');
  }

  function renderSkeleton(){ $('#grid').innerHTML = Array.from({length:9}).map(()=>`<article class="card"><div style="height:210px;background:#eee"></div><div class="card-body"><div style="height:14px;background:#eee"></div></div></article>`).join(''); }

  async function load(){
    renderSkeleton();
    if(!state.cityId && !state.hid && state.q) await resolveCityIfNeeded();

    // try #1 — unified /api/search (ของคุณ)
    let data;
    {
      const u=new URL('/api/search', location.origin);
      const p=u.searchParams;
      if(state.hid) p.set('hid', state.hid); else if(state.cityId) p.set('cityId', state.cityId); else if(state.q) p.set('q', state.q);
      ['checkin','checkout','rooms','adults','children','lang','currency','sort','starsMin','scoreMin','priceMin','priceMax'].forEach(k=>p.set(k, state[k]));
      data = await fetchJson(u.toString());
    }

    // try #2a — by hotelId via /api/hotel-search
    if((!data||!data.ok||!Array.isArray(data.results)||data.results.length===0) && state.hid){
      const u=new URL('/api/hotel-search', location.origin);
      const p=u.searchParams;
      p.set('hotelId', state.hid);
      p.set('checkin', state.checkin||''); p.set('checkout', state.checkout||'');
      p.set('adults', String(state.adults||2)); p.set('children', String(state.children||0));
      p.set('lang','en-us'); data = await fetchJson(u.toString());
    }

    // try #2b — by cityId via /api/hotel-search (limit=30)
    if((!data||!data.ok||!Array.isArray(data.results)||data.results.length===0) && state.cityId){
      const u=new URL('/api/hotel-search', location.origin);
      const p=u.searchParams;
      p.set('cityId', state.cityId); p.set('limit','30');
      p.set('checkin', state.checkin||''); p.set('checkout', state.checkout||'');
      p.set('rooms', String(state.rooms||1)); p.set('adults', String(state.adults||2)); p.set('children', String(state.children||0));
      p.set('lang','en-us'); data = await fetchJson(u.toString());
    }

    let items = data?.results || data?.items || [];
    if(!Array.isArray(items)) items=[];

    if(state.sort==='price_asc') items.sort((a,b)=>(a.price??1e15)-(b.price??1e15));
    if(state.sort==='price_desc') items.sort((a,b)=>(b.price??0)-(a.price??0));

    render(items);
    setPartner();
  }

  // chips (ค่าบน UI → state แล้วยิงใหม่)
  const draft = { sort: state.sort, starsMin: state.starsMin, scoreMin: state.scoreMin, priceMin: state.priceMin, priceMax: state.priceMax };
  const updateChips=()=>{
    document.getElementById('chipSortV').textContent = draft.sort==='price_asc'?'Price: Low → High':draft.sort==='price_desc'?'Price: High → Low':'Recommended';
    document.getElementById('chipStarsV').textContent = draft.starsMin?`${draft.starsMin}+`:'Any';
    document.getElementById('chipScoreV').textContent = draft.scoreMin?`${draft.scoreMin}+`:'Any';
    document.getElementById('chipPriceV').textContent = `$${fmt(Math.min(draft.priceMin,draft.priceMax))} – $${fmt(Math.max(draft.priceMin,draft.priceMax))}`;
  };
  updateChips();
  document.getElementById('chipApply').addEventListener('click',()=>{ Object.assign(state, draft); load(); });

  // (ย่อส่วน—สามารถเพิ่ม dialog/ปรับค่าได้ภายหลัง)
  load();
})();
</script>
</body>
</html>
