<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ผลการค้นหาโรงแรม | Click & Go</title>
  <meta name="description" content="ค้นหาและเปรียบเทียบดีลโรงแรมจากพาร์ทเนอร์ของเรา แล้วคลิกจองได้ทันที" />
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css" />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1QR2EGFWN3"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config','G-1QR2EGFWN3');
  </script>
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="inner">
      <a href="index.html" class="brand" aria-label="Click & Go">
        <img src="logo.png" alt="Click & Go" width="40" height="40" loading="lazy">
      </a>
      <nav class="main-nav" aria-label="เมนูหลัก">
        <a href="index.html">หน้าแรก</a>
        <a href="deals.html">โปรโมชั่น</a>
        <div class="lang">
          <button class="lang-btn" aria-haspopup="true" aria-expanded="false">ภาษา ▾</button>
          <div class="lang-menu" role="menu">
            <a role="menuitem" href="#" aria-current="true">ไทย</a>
            <a role="menuitem" href="en/search.html">English</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <section>
      <h1 class="section-title">ผลการค้นหาโรงแรม</h1>

      <!-- ฟอร์มค้นหาซ้ำ (แก้ไข/เปลี่ยนพารามิเตอร์แล้ว submit ได้เลย) -->
      <form id="re-search" class="search-form search-4cols" method="GET" action="search.html" role="search">
        <input name="q" id="q" type="text" placeholder="ปลายทางหรือชื่อโรงแรม">
        <div class="date-wrap empty"><input name="checkin" id="checkin" type="date"><span class="date-placeholder">เช็คอิน</span></div>
        <div class="date-wrap empty"><input name="checkout" id="checkout" type="date"><span class="date-placeholder">เช็คเอาท์</span></div>
        <button class="btn" type="submit">ค้นหา</button>
      </form>

      <p id="meta" class="muted" style="margin:10px 0"></p>

      <div id="results" class="deal-grid" style="margin-top:12px"></div>
      <div id="empty" class="muted" style="display:none;margin-top:12px">ไม่พบผลลัพธ์ที่ตรงกับการค้นหา</div>
      <div id="loading" class="muted" style="margin-top:12px">กำลังโหลด...</div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container" style="text-align:center">
      <div class="footer-links">
        <a href="privacy.html">Privacy</a> ·
        <a href="terms.html">Terms</a> ·
        <a href="affiliate.html">Affiliate Disclosure</a> ·
        <a href="about.html">About us</a> ·
        <a href="contact.html">Contact</a> ·
        <a href="https://web.facebook.com/clickandgothailand" target="_blank" rel="nofollow noopener">Facebook</a>
      </div>
    </div>
  </footer>

  <script>
  // toggle language menu
  (function(){
    const btn=document.querySelector('.lang-btn'); const menu=document.querySelector('.lang-menu');
    if(!btn||!menu) return;
    const close=()=>{menu.classList.remove('open');btn.setAttribute('aria-expanded','false');};
    btn.addEventListener('click',e=>{e.stopPropagation();const opened=menu.classList.toggle('open');btn.setAttribute('aria-expanded', String(opened));});
    document.addEventListener('click', close); document.addEventListener('keydown',e=>{if(e.key==='Escape') close();});
  })();

  // อ่านพารามิเตอร์จาก URL
  function getParams(){
    const u=new URL(location.href);
    const p=Object.fromEntries(u.searchParams.entries());
    // ค่าเริ่มต้นบางตัว
    if(!p.lang) p.lang='th-th';
    if(!p.currency) p.currency='THB';
    if(!p.adults) p.adults='2';
    if(!p.rooms) p.rooms='1';
    return p;
  }

  function fillForm(p){
    const f=document.getElementById('re-search');
    ['q','checkin','checkout'].forEach(k=>{
      if(f[k] && p[k]) f[k].value=p[k];
    });
    // toggle placeholder ของ date
    document.querySelectorAll('.date-wrap').forEach(w=>{
      const i=w.querySelector('input[type="date"]');
      if(i) w.classList.toggle('empty', !i.value);
      if(i) i.addEventListener('change',()=>w.classList.toggle('empty',!i.value));
    });
  }

  async function run(){
    const p=getParams();
    fillForm(p);

    const meta=document.getElementById('meta');
    const loading=document.getElementById('loading');
    const empty=document.getElementById('empty');
    const results=document.getElementById('results');

    meta.textContent = `ปลายทาง: ${p.q||'-'}  |  วันที่: ${p.checkin||'-'} → ${p.checkout||'-'}  |  ผู้เข้าพัก: ${p.adults||'2'} ผู้ใหญ่, ${p.rooms||'1'} ห้อง`;
    results.innerHTML=''; empty.style.display='none'; loading.style.display='block';

    try{
      const qs=new URLSearchParams(p).toString();
      const resp=await fetch('/api/search?'+qs);
      const data=await resp.json();

      loading.style.display='none';

      if(!data.ok || !Array.isArray(data.items) || data.items.length===0){
        empty.style.display='block';
        return;
      }

      // วาดผลลัพธ์
      results.innerHTML = data.items.map(h => `
        <article class="deal-card">
          <img class="thumb" src="${h.imageUrl || ''}" alt="${h.name || ''}">
          <div class="body">
            <h3>${h.name || ''}</h3>
            <p>${h.city || ''}</p>
          </div>
          <div class="meta">
            ${h.priceFrom ? `<strong>${h.priceFrom.toLocaleString()} ${h.currency || ''}</strong>` : ''}
            <a class="btn" target="_blank" rel="nofollow sponsored noopener" href="${h.deeplink}">ดูดีล</a>
          </div>
        </article>
      `).join('');
    }catch(e){
      loading.style.display='none';
      empty.style.display='block';
      console.error(e);
    }
  }

  run();
  </script>
</body>
</html>
