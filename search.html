<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ผลการค้นหาโรงแรม | Click & Go</title>
  <meta name="description" content="ค้นหา เปรียบเทียบ และจองโรงแรมกับ Click & Go – แสดงผลพร้อมตัวกรองและเรียงลำดับ" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* ===== Toolbar / Filters ===== */
    .toolbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin:10px 0 16px}
    .tool-left{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .tool-right{display:flex;align-items:center;gap:10px}
    .chip{background:#eef2f2;color:#066; border:1px solid #dde6e6; padding:6px 10px;border-radius:999px;font-size:13px}
    .btn-outline{border:1px solid #cfd8d8;background:#fff;color:#222;border-radius:8px;height:38px;padding:0 12px;cursor:pointer}
    .btn-primary{border:0;background:#0ea5a0;color:#fff;border-radius:8px;height:38px;padding:0 14px;cursor:pointer;font-weight:700}
    .select{height:38px;border:1px solid #d7d7d7;border-radius:8px;padding:0 10px;background:#fff}

    /* ===== List ===== */
    .result-grid{display:grid;gap:14px;grid-template-columns:1fr}
    .hotel-card{display:flex;gap:12px;border:1px solid #eee;border-radius:12px;padding:10px;background:#fff;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .hotel-card img{width:135px;height:90px;object-fit:cover;border-radius:8px;background:#f3f3f3}
    .hotel-body{flex:1;display:flex;flex-direction:column;gap:6px}
    .h-title{font-weight:800;margin:0;color:#222}
    .h-meta{font-size:13px;color:#666}
    .h-tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px;font-size:12px;color:#334155}
    .h-price{margin-left:auto;text-align:right;min-width:92px}
    .price{font-weight:800;color:#0a766f}
    .load-more{display:flex;justify-content:center;margin:18px 0}
    .skeleton{animation:pulse 1.3s ease-in-out infinite;background:linear-gradient(90deg,#f3f4f6 25%,#eceff1 37%,#f3f4f6 63%);background-size:400% 100%}
    @keyframes pulse{0%{background-position:100% 0}100%{background-position:0 0}}

    /* ===== Filter sheet (modal) ===== */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:99}
    .sheet{position:fixed;right:0;top:0;bottom:0;width:min(92vw,380px);background:#fff;
      box-shadow:-10px 0 24px rgba(0,0,0,.12);transform:translateX(100%);transition:.25s;z-index:100}
    .sheet.open{transform:none}
    .backdrop.show{display:block}
    .sheet-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding:12px}
    .sheet-body{padding:12px}
    .field{margin:12px 0}
    .field label{display:block;font-weight:700;margin-bottom:6px}
    .row{display:flex;gap:10px}
    .row input[type="number"]{flex:1;height:40px;border:1px solid #d7d7d7;border-radius:8px;padding:0 10px}
    .stars{display:flex;gap:10px}
    .stars label{display:flex;gap:6px;align-items:center}
    .action{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid #eee;padding:12px}
    @media(min-width:860px){.result-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1100px){.result-grid{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>

<body>
  <!-- Header (ใช้ของเดิมในโปรเจ็กต์) -->
  <header class="site-header" role="banner">
    <div class="inner">
      <a href="/index.html" class="brand">
        <img src="/logo.png" alt="Click & Go" width="40" height="40" />
        <span class="brand-text">Click & Go</span>
      </a>
      <nav class="main-nav">
        <a href="/index.html">หน้าแรก</a>
        <a href="/deals.html">โปรโมชั่น</a>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top:12px">
    <h1 class="section-title">ผลการค้นหาโรงแรม</h1>
    <div id="summary" class="muted" style="margin:-6px 0 8px"></div>

    <!-- === Toolbar === -->
    <div class="toolbar">
      <div class="tool-left">
        <span id="chips" class="chip">แสดง 30 รายการแรก</span>
      </div>
      <div class="tool-right">
        <select id="sort" class="select" aria-label="เรียงลำดับ">
          <option value="PRICE_ASC">ราคาต่ำ → สูง</option>
          <option value="PRICE_DESC">ราคาสูง → ต่ำ</option>
          <option value="STAR_DESC">ดาวมาก → น้อย</option>
          <option value="REVIEW_DESC">รีวิวดี → แย่</option>
        </select>
        <button id="btnOpenFilter" class="btn-outline">ตัวกรอง</button>
      </div>
    </div>

    <!-- === Result list === -->
    <div id="result" class="result-grid"></div>

    <div class="load-more">
      <button id="btnMore" class="btn-primary">โหลดเพิ่มเติม</button>
    </div>
  </main>

  <!-- === Filter Sheet (Modal) === -->
  <div id="backdrop" class="backdrop" role="presentation"></div>
  <aside id="sheet" class="sheet" role="dialog" aria-labelledby="sheetTitle" aria-modal="true">
    <div class="sheet-head">
      <div id="sheetTitle" style="font-weight:800">ตัวกรอง</div>
      <button id="btnCloseSheet" class="btn-outline">✕</button>
    </div>
    <div class="sheet-body">
      <div class="field">
        <label>ช่วงราคา (THB)</label>
        <div class="row">
          <input type="number" id="minPrice" placeholder="ต่ำสุด" min="0">
          <input type="number" id="maxPrice" placeholder="สูงสุด" min="0">
        </div>
      </div>

      <div class="field">
        <label>จำนวนดาว</label>
        <div class="stars">
          <label><input type="checkbox" class="star" value="5" checked> 5★</label>
          <label><input type="checkbox" class="star" value="4" checked> 4★</label>
          <label><input type="checkbox" class="star" value="3"> 3★</label>
        </div>
      </div>

      <div class="field">
        <label>คะแนนรีวิวขั้นต่ำ</label>
        <select id="reviewMin" class="select" style="width:100%">
          <option value="">ทั้งหมด</option>
          <option value="9">9.0+</option>
          <option value="8" selected>8.0+</option>
          <option value="7">7.0+</option>
        </select>
      </div>
    </div>
    <div class="action">
      <button id="btnReset" class="btn-outline">ล้างค่า</button>
      <button id="btnApply" class="btn-primary">ปรับใช้ตัวกรอง</button>
    </div>
  </aside>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container" style="text-align:center">
      <div class="footer-links">
        <a href="/privacy.html">Privacy</a> ·
        <a href="/terms.html">Terms</a> ·
        <a href="/about.html">About</a>
      </div>
    </div>
  </footer>

  <script>
    // ---------- Utils ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const params = new URLSearchParams(location.search);
    const q = params.get('q') || 'Bangkok';
    const checkin  = params.get('checkin')  || new Date().toISOString().slice(0,10);
    const checkout = params.get('checkout') || new Date(Date.now()+86400000).toISOString().slice(0,10);
    const rooms = + (params.get('rooms') || 1);
    const adults = + (params.get('adults') || 2);
    const children = + (params.get('children') || 0);

    let page = 1, limit = 30, loading=false, done=false;

    // ตัวกรอง (state)
    let state = {
      sort: 'PRICE_ASC',
      minPrice: params.get('minPrice') ? +params.get('minPrice') : '',
      maxPrice: params.get('maxPrice') ? +params.get('maxPrice') : '',
      stars: params.get('stars') ? params.get('stars').split(',').map(s=>+s) : [5,4],
      reviewMin: params.get('reviewMin') || '8'
    };

    // ---------- Init UI ----------
    $('#summary').textContent = `${q} | วันที่: ${checkin} → ${checkout} | ผู้เข้าพัก: ${adults} ผู้ใหญ่, ${children} เด็ก, ${rooms} ห้อง`;
    $('#sort').value = state.sort;
    if (state.minPrice) $('#minPrice').value = state.minPrice;
    if (state.maxPrice) $('#maxPrice').value = state.maxPrice;
    if (state.reviewMin) $('#reviewMin').value = state.reviewMin;
    $$('.star').forEach(el => el.checked = state.stars.includes(+el.value));
    renderChips();

    // ---------- Toolbar events ----------
    $('#sort').addEventListener('change', () => { state.sort = $('#sort').value; resetAndLoad(); });
    $('#btnOpenFilter').addEventListener('click', openSheet);
    $('#btnCloseSheet').addEventListener('click', closeSheet);
    $('#backdrop').addEventListener('click', closeSheet);
    $('#btnReset').addEventListener('click', () => {
      state.minPrice=''; state.maxPrice=''; state.stars=[5,4]; state.reviewMin='8';
      $('#minPrice').value=''; $('#maxPrice').value=''; $('#reviewMin').value='8';
      $$('.star').forEach(el=> el.checked = ['5','4'].includes(el.value));
    });
    $('#btnApply').addEventListener('click', () => {
      state.minPrice = $('#minPrice').value ? +$('#minPrice').value : '';
      state.maxPrice = $('#maxPrice').value ? +$('#maxPrice').value : '';
      state.stars = $$('.star:checked').map(el=>+el.value);
      state.reviewMin = $('#reviewMin').value || '';
      closeSheet(); renderChips(); resetAndLoad();
    });

    $('#btnMore').addEventListener('click', () => load());

    function openSheet(){ $('#backdrop').classList.add('show'); $('#sheet').classList.add('open'); }
    function closeSheet(){ $('#backdrop').classList.remove('show'); $('#sheet').classList.remove('open'); }

    function renderChips(){
      const chips = [];
      if (state.minPrice) chips.push(`≥ ${state.minPrice}฿`);
      if (state.maxPrice) chips.push(`≤ ${state.maxPrice}฿`);
      if (state.stars.length) chips.push(`${state.stars.join('/')}★`);
      if (state.reviewMin) chips.push(`รีวิว ${state.reviewMin}+`);
      $('#chips').textContent = chips.length ? chips.join(' · ') : 'แสดง 30 รายการแรก';
    }

    // ---------- Load results ----------
    const container = $('#result');

    function resetAndLoad(){
      page = 1; done = false; container.innerHTML = ''; $('#btnMore').style.display='flex';
      const newParams = new URLSearchParams({q,checkin,checkout,rooms,adults,children,sort:state.sort,limit});
      if(state.minPrice) newParams.set('minPrice', state.minPrice);
      if(state.maxPrice) newParams.set('maxPrice', state.maxPrice);
      if(state.stars?.length) newParams.set('stars', state.stars.join(','));
      if(state.reviewMin) newParams.set('reviewMin', state.reviewMin);
      history.replaceState(null,'',`?${newParams.toString()}`);
      load();
    }

    async function load(){
      if(loading || done) return;
      loading = true;

      // Skeleton
      for(let i=0; i<6; i++){
        const sk = document.createElement('div');
        sk.className = 'hotel-card skeleton';
        sk.style.height='110px';
        container.appendChild(sk);
      }

      try{
        const offset = (page-1)*limit;
        const url = new URL('/api/search', location.origin);
        url.searchParams.set('q', q);
        url.searchParams.set('checkin', checkin);
        url.searchParams.set('checkout', checkout);
        url.searchParams.set('rooms', rooms);
        url.searchParams.set('adults', adults);
        url.searchParams.set('children', children);
        url.searchParams.set('limit', limit);
        url.searchParams.set('offset', offset);
        url.searchParams.set('sort', state.sort);
        if(state.minPrice) url.searchParams.set('minPrice', state.minPrice);
        if(state.maxPrice) url.searchParams.set('maxPrice', state.maxPrice);
        if(state.stars?.length) url.searchParams.set('stars', state.stars.join(','));
        if(state.reviewMin) url.searchParams.set('reviewMin', state.reviewMin);

        const res = await fetch(url.toString());
        const data = await res.json();

        // ลบ skeleton
        container.querySelectorAll('.skeleton').forEach(el=>el.remove());

        const items = data.items || [];
        if(items.length === 0 && page === 1){
          container.innerHTML = `<div class="muted">ไม่พบโรงแรมที่ตรงกับตัวกรอง</div>`;
          $('#btnMore').style.display='none';
          done = true; return;
        }
        renderList(items);
        if(items.length < limit){ $('#btnMore').style.display='none'; done = true; }
        page++;
      }catch(e){
        console.error(e);
        container.querySelectorAll('.skeleton').forEach(el=>el.remove());
        if(page===1) container.innerHTML = `<div class="muted">เกิดข้อผิดพลาดในการดึงข้อมูล</div>`;
        $('#btnMore').style.display='none';
      } finally {
        loading = false;
      }
    }

    function renderList(items){
      for(const it of items){
        const el = document.createElement('div');
        el.className = 'hotel-card';
        el.innerHTML = `
          <img src="${it.imageUrl||'/hero-bg.jpg'}" alt="${escapeHtml(it.name||'Hotel')}">
          <div class="hotel-body">
            <div style="display:flex;gap:10px">
              <h3 class="h-title">${escapeHtml(it.name)}</h3>
              <div class="h-price">
                <div class="price">${formatPrice(it.priceFrom, it.currency||'THB')}</div>
                <div class="h-meta">${it.freeCancellation?'ยกเลิกฟรี':''}</div>
              </div>
            </div>
            <div class="h-meta">${escapeHtml(it.city||'')} · ${it.starRating||'-'}★ · คะแนน ${it.reviewScore||'-'} (${it.reviewCount||0})</div>
            <div class="h-tags">
              ${it.mealPlan?`<span class="tag">${escapeHtml(it.mealPlan)}</span>`:''}
            </div>
            <div style="margin-top:auto;display:flex;gap:8px;justify-content:flex-end">
              <a class="btn-outline" href="${it.deeplink||'#'}" target="_blank" rel="nofollow noopener">ดูดีล</a>
            </div>
          </div>
        `;
        container.appendChild(el);
      }
    }

    function formatPrice(p, cur){ if(!p) return '-'; return new Intl.NumberFormat('th-TH').format(p)+' '+cur; }
    function escapeHtml(s){ return (''+s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    // เริ่มโหลดครั้งแรก
    resetAndLoad();
  </script>
</body>
</html>
