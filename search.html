<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ข้อเสนอที่ดีที่สุด | Click & Go</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{
      --brand:#0aa297;
      --card-border:#0aa29733;
      --gold:#d4a017;
      --muted:#666;
    }
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .main-title{font-size:42px;line-height:1.2;margin:8px 0 6px}
    @media(max-width:640px){.main-title{font-size:34px}}
    .muted{color:var(--muted)}
    .nowrap{white-space:nowrap}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 16px}
    .select,.input{height:40px;border:1px solid #ddd;border-radius:10px;padding:0 10px;background:#fff}
    .input{width:120px}
    @media(max-width:640px){.input{width:110px}}
    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media(max-width:980px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.07);border:2px solid var(--card-border)}
    .card img{width:100%;height:210px;object-fit:cover;display:block;background:#f4f4f4}
    .card-body{padding:14px;display:flex;flex-direction:column;min-height:180px}
    .price{font-weight:700;margin-top:8px}
    .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;text-decoration:none}
    .btn:focus{outline:3px solid #0aa29755;outline-offset:2px}
    .h-actions{margin-top:auto;display:flex;justify-content:flex-end}
    .stars{display:inline-flex;gap:2px;vertical-align:middle}
    .star{width:16px;height:16px;display:inline-block}
    .star svg{width:100%;height:100%;fill:var(--gold)}
    .score{color:#c62828}
    .skeleton{background:linear-gradient(90deg,#f2f2f2 25%,#e9e9e9 37%,#f2f2f2 63%);animation:s 1.4s ease infinite}
    @keyframes s{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
    .sk-img{height:210px}
    .sk-line{height:14px;margin-top:8px;border-radius:6px}
    .cta-wrap{display:flex;justify-content:center;margin:28px 0}
    .cta{padding:12px 22px;border-radius:999px;font-weight:600}
    .sep{opacity:.35;margin:0 4px}
    .toolbar label{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
<header class="site-header" role="banner">
  <div class="inner">
    <a href="/index.html" class="brand"><img src="/logo.png" width="40" height="40" alt="Click & Go"><span class="brand-text">Click & Go</span></a>
    <nav class="main-nav">
      <a href="/index.html">หน้าแรก</a>
      <a href="/deals.html">โปรโมชั่น</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 id="title" class="main-title">ข้อเสนอที่ดีที่สุด</h1>
  <p class="muted" id="subtitle"></p>

  <div class="toolbar">
    <label>เรียงโดย
      <select id="sort" class="select">
        <option value="rec">แนะนำ</option>
        <option value="price_asc">ราคาต่ำ → สูง</option>
        <option value="price_desc">ราคาสูง → ต่ำ</option>
      </select>
    </label>

    <span class="sep">|</span>

    <label>ราคาต่ำสุด
      <input id="priceMin" class="input" type="number" min="1" step="1" placeholder="เช่น 500">
    </label>

    <label>ราคาสูงสุด
      <input id="priceMax" class="input" type="number" min="1" step="1" placeholder="เช่น 5000">
    </label>

    <span class="sep">|</span>

    <label>เรตติ้ง
      <select id="starsMin" class="select">
        <option value="0">ทั้งหมด</option>
        <option value="1">1★ ขึ้นไป</option>
        <option value="2">2★ ขึ้นไป</option>
        <option value="3">3★ ขึ้นไป</option>
        <option value="4">4★ ขึ้นไป</option>
        <option value="5">5★ เท่านั้น</option>
      </select>
    </label>

    <label>คะแนนรีวิว
      <input id="scoreMin" class="input" type="number" min="0" max="10" step="0.1" placeholder="เช่น 8.0">
    </label>

    <span class="sep">|</span>

    <label>สกุลเงิน
      <select id="currency" class="select">
        <option>THB</option>
        <option>USD</option>
        <option>EUR</option>
        <option>JPY</option>
      </select>
    </label>
  </div>

  <section id="grid" class="cards" aria-live="polite"></section>

  <div class="cta-wrap">
    <a id="partnerMore" class="btn cta" href="#" target="_blank" rel="nofollow noopener">ค้นหาเพิ่มเติมจากพันธมิตรของเรา</a>
  </div>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);

  const state = {
    q: params.get('q') || '',
    cityId: params.get('cityId') || params.get('cityid') || '',
    hid: params.get('hid') || '',
    city: params.get('city') || '',
    country: params.get('country') || '',
    checkin: params.get('checkin'),
    checkout: params.get('checkout'),
    rooms: +(params.get('rooms') || 1),
    adults: +(params.get('adults') || 2),
    children: +(params.get('children') || 0),
    lang: (params.get('lang') || 'th-th').toLowerCase(),
    currency: params.get('currency') || 'THB',
    sort: params.get('sort') || 'rec',
    page: +(params.get('page') || 1),

    // ฟิลเตอร์ใหม่
    priceMin: +(params.get('priceMin') || 1),
    priceMax: +(params.get('priceMax') || 1000000),
    starsMin: +(params.get('starsMin') || 0),
    scoreMin: +(params.get('scoreMin') || 0)
  };

  // set UI
  $('#currency').value = state.currency;
  $('#sort').value = state.sort;
  $('#priceMin').value = state.priceMin;
  $('#priceMax').value = state.priceMax;
  $('#starsMin').value = String(state.starsMin);
  $('#scoreMin').value = state.scoreMin;

  // subtitle (ผู้เข้าพัก ให้คงอยู่บรรทัดเดียว)
  const human = (() => {
    const ci = state.checkin?.replaceAll('-', '/');
    const co = state.checkout?.replaceAll('-', '/');
    const guestTxt = `<span class="nowrap">ผู้เข้าพัก:</span> ${state.adults} ผู้ใหญ่, ${state.children} เด็ก, ${state.rooms} ห้อง`;
    const place = state.city || state.q || '—';
    return {place, range: `${ci} → ${co}`, guestTxt};
  })();
  $('#subtitle').innerHTML = `${human.place} | วันที่: ${human.range} | ${human.guestTxt}`;

  function updateQueryOnly(){
    const u = new URL(location.href);
    Object.entries({
      q: state.q || '',
      cityId: state.cityId || '',
      hid: state.hid || '',
      city: state.city || '',
      country: state.country || '',
      checkin: state.checkin,
      checkout: state.checkout,
      rooms: state.rooms,
      adults: state.adults,
      children: state.children,
      lang: state.lang,
      currency: state.currency,
      page: state.page,
      sort: state.sort,
      priceMin: state.priceMin,
      priceMax: state.priceMax,
      starsMin: state.starsMin,
      scoreMin: state.scoreMin
    }).forEach(([k,v])=>{
      if (v === '' || v == null) u.searchParams.delete(k);
      else u.searchParams.set(k, v);
    });
    history.replaceState({}, '', u);
  }

  // resolve q -> id ถ้ายังไม่มี
  async function resolveDestinationIfNeeded(){
    if ((state.cityId || state.hid) || !state.q) return;
    try{
      const url = `/api/suggest?q=${encodeURIComponent(state.q)}&lang=${encodeURIComponent(state.lang)}&type=mixed`;
      const res = await fetch(url, {cache:'no-store'});
      const data = await res.json();
      if (data && data.ok && Array.isArray(data.items) && data.items.length){
        const firstHotel = data.items.find(it => String(it.type||'').toLowerCase().includes('hotel'));
        const firstCity  = data.items.find(it => String(it.type||'').toLowerCase().includes('city'));
        const pick = firstHotel || firstCity || data.items[0];
        const t = String(pick.type||'').toLowerCase();
        if (t.includes('hotel')) state.hid = String(pick.id||pick.hotel_id||'');
        if (t.includes('city'))  state.cityId = String(pick.city_id ?? pick.value ?? pick.id ?? '');
        state.city = pick.label || pick.city_name || state.city;
        updateQueryOnly();
      }
    }catch(_){}
  }

  // คืนจำนวนคืน
  function calcLos(ci, co){
    try{
      const a = new Date(ci+'T12:00:00Z'), b = new Date(co+'T12:00:00Z');
      const diff = Math.round((b-a)/(1000*60*60*24));
      return Math.max(1, diff||1);
    }catch(e){ return 1; }
  }

  // ลิงก์ CTA ไป Agoda + กันเปิดแอป + ใส่ cid
  function partnerUrl(){
    const langPath = state.lang || 'th-th';

    if (state.cityId) {
      const base = `https://www.agoda.com/${langPath}/partners/partnersearch.aspx`;
      const sp = new URLSearchParams({
        cid: '1949420',
        city: String(state.cityId),
        checkin: state.checkin || '',
        checkout: state.checkout || '',
        rooms: String(state.rooms || 1),
        adults: String(state.adults || 2),
        children: String(state.children || 0),
        currency: state.currency || 'THB',
        utm_source: 'clickandgo',
        utm_medium: 'affiliate',
        noapp: '1',
        pcs: '1'
      });
      return `${base}?${sp.toString()}`;
    }

    // fallback
    const base = `https://www.agoda.com/${langPath}/search`;
    const sp = new URLSearchParams({
      cid: '1949420',
      currency: state.currency || 'THB',
      checkin: state.checkin || '',
      checkout: state.checkout || '',
      adults: String(state.adults || 2),
      children: String(state.children || 0),
      rooms: String(state.rooms || 1),
      los: String(calcLos(state.checkin, state.checkout)),
      utm_source: 'clickandgo',
      utm_medium: 'affiliate',
      noapp: '1',
      pcs: '1'
    });
    if (state.q) sp.set('q', state.q);
    return `${base}?${sp.toString()}`;
  }
  function refreshPartnerCta(){
    $('#partnerMore').setAttribute('href', partnerUrl());
  }

  async function load(){
    renderSkeleton();

    if (!state.cityId && !state.hid && state.q) {
      await resolveDestinationIfNeeded();
    }

    const api = new URL('/api/search', location.origin);
    const p = api.searchParams;

    if (state.hid) p.set('hid', state.hid);
    else if (state.cityId) p.set('cityId', state.cityId);
    else if (state.q) p.set('q', state.q);

    ['checkin','checkout','rooms','adults','children','lang','currency','page','sort'].forEach(k => p.set(k, state[k]));
    // ใส่ฟิลเตอร์ใหม่ไปที่ API
    p.set('priceMin', state.priceMin);
    p.set('priceMax', state.priceMax);
    p.set('starsMin', state.starsMin);
    p.set('scoreMin', state.scoreMin);

    const resp = await fetch(api.toString(), {cache: 'no-store'});
    const json = await resp.json().catch(()=>({ok:false}));

    if (!json.ok){
      $('#grid').innerHTML = `<p class="muted">ไม่พบผลลัพธ์ที่ตรงกับการค้นหา</p>`;
      refreshPartnerCta();
      return;
    }

    // fallback กรองฝั่งหน้าเพิ่มเล็กน้อย
    let items = (json.results || []).filter(h=>{
      const priceOk = !state.priceMin && !state.priceMax ? true :
        (h.price==null ? true : (h.price >= state.priceMin && h.price <= state.priceMax));
      const starOk  = (h.rating ?? 0) >= state.starsMin;
      const scoreOk = (h.reviewScore ?? 0) >= state.scoreMin;
      return priceOk && starOk && scoreOk;
    });

    if (state.sort === 'price_asc') items.sort((a,b)=>(a.price||1e15)-(b.price||1e15));
    if (state.sort === 'price_desc') items.sort((a,b)=>(b.price||0)-(a.price||0));

    render(items);
    refreshPartnerCta();
  }

  function renderSkeleton(){
    const sk = Array.from({length: 9}).map(()=>`
      <article class="card" aria-busy="true">
        <div class="sk-img skeleton"></div>
        <div class="card-body">
          <div class="sk-line skeleton" style="width:70%"></div>
          <div class="sk-line skeleton" style="width:40%"></div>
          <div class="sk-line skeleton" style="width:50%"></div>
        </div>
      </article>`).join('');
    $('#grid').innerHTML = sk;
  }

  function starIcons(n){
    const c = Math.max(0, Math.min(5, Math.round(n||0)));
    return `<span class="stars" aria-label="${c} ดาว">` +
      Array.from({length:c}).map(()=>`
        <span class="star" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </span>`).join('') +
      `</span>`;
  }

  function render(list){
    if (!list.length){
      $('#grid').innerHTML = `<p class="muted">ไม่พบผลลัพธ์ที่ตรงกับการค้นหา</p>`;
      return;
    }
    const html = list.map(h => `
      <article class="card">
        <img src="${esc(h.thumbnail || '')}" alt="${esc(h.name)}">
        <div class="card-body">
          <h3 style="font-size:18px;margin:0 0 6px">${esc(h.name)}</h3>
          <div class="muted" style="font-size:13px">
            ${starIcons(h.rating ?? 0)}
            &nbsp;·&nbsp;<span class="score">คะแนนรีวิว ${h.reviewScore ?? '-'}</span>
          </div>
          <div class="price">${fmt(h.price)} ${esc(h.currency || state.currency)}</div>
          <div class="h-actions">
            <a class="btn" href="${esc(h.url || '#')}" target="_blank" rel="nofollow noopener">ดูข้อเสนอ</a>
          </div>
        </div>
      </article>
    `).join('');
    $('#grid').innerHTML = html;
  }

  function fmt(n){
    if (n == null) return '-';
    try { return new Intl.NumberFormat('th-TH',{maximumFractionDigits:2}).format(n); }
    catch(e){ return String(n); }
  }
  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // events
  $('#currency').addEventListener('change', e => {
    state.currency = e.target.value;
    updateQueryOnly(); load();
  });
  $('#sort').addEventListener('change', e => {
    state.sort = e.target.value;
    updateQueryOnly(); load();
  });
  $('#priceMin').addEventListener('change', e => {
    state.priceMin = Math.max(1, +e.target.value || 1);
    if (state.priceMax < state.priceMin) state.priceMax = state.priceMin;
    $('#priceMax').value = state.priceMax;
    updateQueryOnly(); load();
  });
  $('#priceMax').addEventListener('change', e => {
    const v = Math.max(1, +e.target.value || 1);
    state.priceMax = Math.max(state.priceMin, v);
    e.target.value = state.priceMax;
    updateQueryOnly(); load();
  });
  $('#starsMin').addEventListener('change', e => {
    state.starsMin = +e.target.value || 0;
    updateQueryOnly(); load();
  });
  $('#scoreMin').addEventListener('change', e => {
    let v = parseFloat(e.target.value);
    if (!Number.isFinite(v)) v = 0;
    v = Math.max(0, Math.min(10, v));
    state.scoreMin = v;
    e.target.value = v;
    updateQueryOnly(); load();
  });

  load();
})();
</script>
</body>
</html>
```0
