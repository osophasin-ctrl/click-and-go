<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ผลการค้นหาโรงแรม | Click & Go</title>
  <meta name="description" content="ผลการค้นหาโรงแรม พร้อมตัวกรอง ราคา เรียงลำดับ และโหลดผลลัพธ์เพิ่ม" />
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== Filter Bar (Sticky) ===== */
    .filter-bar{
      position:sticky; top:0; z-index:20;
      background:#fff; border-bottom:1px solid #eee;
    }
    .filter-wrap{
      max-width:1100px; margin:0 auto; padding:8px 16px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      height:36px; display:inline-flex; align-items:center; gap:8px;
      padding:0 12px; border:1px solid #ddd; border-radius:999px;
      background:#fff; color:#222; cursor:pointer;
    }
    .chip:disabled{ opacity:.5; cursor:not-allowed; }
    .chip .caret{ font-size:12px; }

    /* ===== Summary ===== */
    .result-head{
      max-width:1100px; margin:12px auto 8px; padding:0 16px;
    }
    .result-title{ margin:8px 0 4px; font-size:clamp(20px,3vw,28px); font-weight:800; }
    .result-sub{ color:#555; margin:0; }

    /* ===== Result grid / card ===== */
    .result-grid{ max-width:1100px; margin:10px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: repeat(3,1fr); }
    @media (max-width:980px){ .result-grid{ grid-template-columns: repeat(2,1fr); } }
    @media (max-width:620px){ .result-grid{ grid-template-columns: 1fr; } }

    .hotel-card{
      border:1px solid #eee; border-radius:12px; background:#fff;
      overflow:hidden; box-shadow:0 1px 10px rgba(0,0,0,.04); display:flex; flex-direction:column;
    }
    .hotel-thumb{ width:100%; aspect-ratio:16/9; object-fit:cover; background:#f1f1f1; display:block; }
    .hotel-body{ padding:12px 12px 10px; }
    .hotel-name{ margin:0 0 4px; font-size:18px; font-weight:700; color:#222; }
    .hotel-meta{ font-size:13px; color:#666; }
    .hotel-foot{ display:flex; align-items:center; justify-content:space-between; padding:0 12px 12px; margin-top:auto; }
    .price{ font-weight:800; color:#222; }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eefaf8; color:#0b8e78; }
    .btn-more{
      display:block; margin:12px auto 24px; padding:10px 16px; border-radius:8px; background:#0ea5a0; color:#fff; border:0; cursor:pointer; font-weight:700;
    }

    /* ===== Drawer / Modal ===== */
    .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:40; }
    .drawer{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:min(94vw,520px); background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.2); display:none; z-index:50; }
    .drawer-header{ padding:14px 16px; border-bottom:1px solid #eee; font-weight:800; display:flex; justify-content:space-between; align-items:center; }
    .drawer-body{ padding:14px 16px; }
    .drawer-footer{ display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #eee; }
    .btn-outline{ border:1px solid #bbb; background:#fff; color:#333; border-radius:8px; padding:8px 14px; }
    .btn-primary{ border:0; background:#0ea5a0; color:#fff; border-radius:8px; padding:8px 14px; }

    .field-row{ display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    .field-row label{ min-width:120px; }
    .field-row input[type="number"], .field-row select{
      border:1px solid #ddd; border-radius:8px; padding:8px 10px; height:40px; min-width:120px;
    }

    /* Sort menu */
    .menu{ position:absolute; background:#fff; border:1px solid #ddd; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.1); padding:6px; display:none; z-index:60; }
    .menu a{ display:block; padding:8px 12px; color:#222; text-decoration:none; border-radius:8px; }
    .menu a:hover{ background:#f6f6f6; }

    /* Toast */
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#333; color:#fff; padding:8px 12px; border-radius:8px; font-size:14px; display:none; z-index:70; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="inner">
      <a href="index.html" class="brand">
        <img src="logo.png" alt="Click & Go" width="40" height="40" />
        <span class="brand-text">Click & Go</span>
      </a>
      <nav class="main-nav">
        <a href="index.html">หน้าแรก</a>
        <a href="deals.html">โปรโมชั่น</a>
      </nav>
    </div>
  </header>

  <!-- Summary -->
  <section class="result-head">
    <h1 class="result-title">ผลการค้นหาโรงแรม</h1>
    <p class="result-sub" id="summary">กำลังโหลด...</p>
  </section>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="filter-wrap">
      <button class="chip" id="btnFilters">ตัวกรอง <span class="caret">▾</span></button>
      <button class="chip" id="btnPrice">ราคา <span id="priceChipText" class="muted"></span> <span class="caret">▾</span></button>
      <button class="chip" id="btnSort">เรียงลำดับ <span class="caret">▾</span></button>
      <button class="chip" id="btnArea" title="เร็วๆ นี้">ย่าน/พื้นที่ <span class="caret">▾</span></button>
      <div id="sortMenu" class="menu">
        <a href="#" data-sort="PRICE_ASC">ราคาต่ำ → สูง</a>
        <a href="#" data-sort="PRICE_DESC">ราคาสูง → ต่ำ</a>
        <a href="#" data-sort="RATING_DESC">คะแนนรีวิวสูง</a>
        <a href="#" data-sort="STARS_DESC">ดาวสูง</a>
      </div>
    </div>
  </div>

  <!-- Results -->
  <section class="result-grid" id="resultGrid"></section>
  <div style="text-align:center">
    <button class="btn-more" id="btnLoadMore" style="display:none">โหลดเพิ่ม</button>
  </div>

  <!-- Drawer: Filters -->
  <div id="backdrop" class="backdrop"></div>
  <div id="drawerFilters" class="drawer" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
    <div class="drawer-header">
      <div id="filterTitle">ตัวกรอง</div>
      <button class="btn-outline" id="btnCloseFilter">×</button>
    </div>
    <div class="drawer-body">
      <div style="font-weight:700; margin-bottom:8px">จำนวนดาว</div>
      <label><input type="checkbox" class="ck-star" value="5" checked> 5★</label> &nbsp;
      <label><input type="checkbox" class="ck-star" value="4" checked> 4★</label> &nbsp;
      <label><input type="checkbox" class="ck-star" value="3"> 3★</label>

      <div class="field-row">
        <label>คะแนนรีวิวขั้นต่ำ</label>
        <select id="reviewMin">
          <option value="0">ทั้งหมด</option>
          <option value="6">6.0+</option>
          <option value="7">7.0+</option>
          <option value="8" selected>8.0+</option>
          <option value="9">9.0+</option>
        </select>
      </div>

      <div style="font-weight:700; margin:12px 0 6px">สิ่งอำนวยความสะดวก</div>
      <label><input type="checkbox" id="ckFreeCancel"> ยกเลิกฟรี</label>
    </div>
    <div class="drawer-footer">
      <button class="btn-outline" id="btnResetFilter">ล้างค่า</button>
      <button class="btn-primary" id="btnApplyFilter">นำไปใช้</button>
    </div>
  </div>

  <!-- Drawer: Price -->
  <div id="drawerPrice" class="drawer" role="dialog" aria-modal="true" aria-labelledby="priceTitle">
    <div class="drawer-header">
      <div id="priceTitle">ช่วงราคา (THB)</div>
      <button class="btn-outline" id="btnClosePrice">×</button>
    </div>
    <div class="drawer-body">
      <div class="field-row">
        <label>ต่ำสุด</label>
        <input type="number" id="minPrice" placeholder="0" min="0" step="100" />
      </div>
      <div class="field-row">
        <label>สูงสุด</label>
        <input type="number" id="maxPrice" placeholder="ไม่จำกัด" min="0" step="100" />
      </div>
    </div>
    <div class="drawer-footer">
      <button class="btn-outline" id="btnResetPrice">ล้างราคา</button>
      <button class="btn-primary" id="btnApplyPrice">นำไปใช้</button>
    </div>
  </div>

  <div id="toast" class="toast">เร็วๆ นี้</div>

  <script>
    // ----- State -----
    const state = {
      cityid: '', q: '',
      checkin: '', checkout: '',
      rooms: 1, adults: 2, children: 0,
      currency: 'THB',
      sort: 'PRICE_ASC',
      minPrice: null, maxPrice: null,
      stars: [5,4], reviewMin: 8,
      freeCancel: false,
      total: 0, loading: false
    };
    const $ = s => document.querySelector(s);

    // ----- UI helpers -----
    function showToast(msg){
      const t = $('#toast'); t.textContent = msg || 'เร็วๆ นี้';
      t.style.display = 'block'; setTimeout(()=>t.style.display='none', 1500);
    }
    function openDrawer(id){ $('#backdrop').style.display='block'; $(id).style.display='block'; }
    function closeDrawer(id){ $('#backdrop').style.display='none'; $(id).style.display='none'; }

    // ----- Parse query from URL -----
    (function initQuery(){
      const p = new URLSearchParams(location.search);
      state.cityid   = p.get('cityid') || '';                 // ✅ ใช้ cityid เป็นหลัก
      state.q        = p.get('q') || 'Bangkok';               // fallback เป็นชื่อเมืองถ้าไม่มี cityid
      state.checkin  = p.get('checkin') || new Date().toISOString().slice(0,10);
      const tomorrow = new Date(Date.now()+24*60*60*1000).toISOString().slice(0,10);
      state.checkout = p.get('checkout') || tomorrow;
      state.rooms    = +(p.get('rooms') || 1);
      state.adults   = +(p.get('adults') || 2);
      state.children = +(p.get('children') || 0);
      state.currency = (p.get('currency') || 'THB').toUpperCase();

      $('#summary').textContent =
        `${state.cityid ? 'City ID: '+state.cityid : state.q} | วันที่: ${state.checkin} → ${state.checkout} | ` +
        `ผู้เข้าพัก: ${state.adults} ผู้ใหญ่, ${state.children} เด็ก, ${state.rooms} ห้อง`;
    })();

    // ----- Normalize Agoda v1 → items -----
    function normalizeItems(data){
      if (Array.isArray(data.items) && data.items.length) return data.items;
      const raw = data?.result?.results;
      if (!Array.isArray(raw)) return [];
      return raw.map(h => ({
        id: String(h.hotelId ?? ''),
        name: h.hotelName ?? '',
        city: state.q || '',
        starRating: h.starRating ?? null,
        reviewScore: h.reviewScore ?? null,
        reviewCount: h.reviewCount ?? null,
        imageUrl: h.imageURL || '',
        priceFrom: h.dailyRate ?? null,
        currency: h.currency || state.currency,
        freeCancellation: !!h.freeWifi,                             // placeholder
        mealPlan: h.includeBreakfast ? 'Breakfast included' : '',
        deeplink: h.landingURL || ''
      }));
    }

    // ----- Fetch results -----
    async function fetchResults(){
      if(state.loading) return;
      state.loading = true;
      try{
        const qs = new URLSearchParams({
          ...(state.cityid ? { cityid: state.cityid } : { q: state.q }),
          checkin:  state.checkin,
          checkout: state.checkout,
          adults:   String(state.adults),
          currency: state.currency
          // debug:'1'
        });
        const url = `/api/search?${qs.toString()}`;
        const res = await fetch(url, { headers:{ 'Accept':'application/json' }, cache:'no-store' });
        const data = await res.json();

        let items = normalizeItems(data);
        state.total = data.total || items.length;

        // client-side filters
        items = items.filter(it=>{
          const okPrice = (state.minPrice==null || (it.priceFrom??0) >= state.minPrice) &&
                          (state.maxPrice==null || (it.priceFrom??0) <= state.maxPrice);
          const okStar  = (!state.stars.length) || state.stars.includes(+it.starRating||0);
          const okRate  = (+it.reviewScore || 0) >= (state.reviewMin||0);
          const okCancel= !state.freeCancel || !!it.freeCancellation;
          return okPrice && okStar && okRate && okCancel;
        });

        // sort client
        items.sort((a,b)=>{
          switch(state.sort){
            case 'PRICE_ASC':  return (a.priceFrom||0) - (b.priceFrom||0);
            case 'PRICE_DESC': return (b.priceFrom||0) - (a.priceFrom||0);
            case 'RATING_DESC':return (b.reviewScore||0) - (a.reviewScore||0);
            case 'STARS_DESC': return (b.starRating||0) - (a.starRating||0);
            default: return 0;
          }
        });

        renderResults(items);
        $('#btnLoadMore').style.display = 'none'; // ยังไม่รองรับ paging

      }catch(e){
        console.error(e);
        $('#resultGrid').innerHTML = `<div style="grid-column:1/-1;color:#c00">เกิดข้อผิดพลาดในการค้นหา กรุณาลองใหม่อีกครั้ง</div>`;
      }finally{
        state.loading = false;
      }
    }

    function renderResults(items){
      const grid = $('#resultGrid');
      grid.innerHTML = items.map(cardHtml).join('');
    }

    function cardHtml(h){
      const stars  = '★'.repeat(h.starRating||0);
      const review = (h.reviewScore!=null) ? `คะแนน ${h.reviewScore}` : '';
      const city   = h.city ? ` · ${h.city}` : '';
      const price  = (h.priceFrom!=null) ? `${Number(h.priceFrom).toLocaleString()} ${h.currency||'THB'}` : '-';
      const fc     = h.freeCancellation ? '<span class="badge">ยกเลิกฟรี</span>' : '';
      const meal   = h.mealPlan ? `<span class="badge">${h.mealPlan}</span>` : '';
      const link   = h.deeplink || '#';

      return `
        <article class="hotel-card">
          <img class="hotel-thumb" src="${h.imageUrl||'https://picsum.photos/800/450?blur=2'}" loading="lazy" alt="${h.name||''}">
          <div class="hotel-body">
            <h3 class="hotel-name">${h.name||'-'}</h3>
            <div class="hotel-meta">${stars} ${review}${city}</div>
          </div>
          <div class="hotel-foot">
            <div class="price">${price}</div>
            <div>${fc} ${meal}</div>
          </div>
          <a href="${link}" target="_blank" rel="nofollow noopener" class="btn" style="margin:0 12px 12px">ดูดีล</a>
        </article>
      `;
    }

    // ----- Events: Filter bar -----
    $('#btnFilters').addEventListener('click', ()=> openDrawer('#drawerFilters'));
    $('#btnCloseFilter').addEventListener('click', ()=> closeDrawer('#drawerFilters'));
    $('#btnResetFilter').addEventListener('click', ()=>{
      document.querySelectorAll('.ck-star').forEach(el=> el.checked=false);
      document.querySelector('.ck-star[value="5"]').checked=true;
      document.querySelector('.ck-star[value="4"]').checked=true;
      $('#reviewMin').value = '8';
      $('#ckFreeCancel').checked = false;
    });
    $('#btnApplyFilter').addEventListener('click', ()=>{
      state.stars = Array.from(document.querySelectorAll('.ck-star:checked')).map(el=>+el.value);
      state.reviewMin = +$('#reviewMin').value;
      state.freeCancel = $('#ckFreeCancel').checked;
      fetchResults();
    });

    function updatePriceChip(){
      const a = state.minPrice!=null ? state.minPrice : '';
      const b = state.maxPrice!=null ? state.maxPrice : '';
      const text = (a||b) ? `(${a||0}–${b||'∞'})` : '';
      $('#priceChipText').textContent = text;
    }
    $('#btnPrice').addEventListener('click', ()=>{
      $('#minPrice').value = state.minPrice ?? '';
      $('#maxPrice').value = state.maxPrice ?? '';
      openDrawer('#drawerPrice');
    });
    $('#btnClosePrice').addEventListener('click', ()=> closeDrawer('#drawerPrice'));
    $('#btnResetPrice').addEventListener('click', ()=>{
      $('#minPrice').value = ''; $('#maxPrice').value = '';
    });
    $('#btnApplyPrice').addEventListener('click', ()=>{
      const mi = $('#minPrice').value ? +$('#minPrice').value : null;
      const ma = $('#maxPrice').value ? +$('#maxPrice').value : null;
      state.minPrice = mi; state.maxPrice = ma; updatePriceChip();
      fetchResults();
    });

    const sortMenu = $('#sortMenu');
    $('#btnSort').addEventListener('click', (e)=>{
      const r = e.currentTarget.getBoundingClientRect();
      sortMenu.style.left = (r.left)+'px';
      sortMenu.style.top = (r.bottom+6)+'px';
      sortMenu.style.display = 'block';
    });
    document.addEventListener('click', (e)=>{
      if(!sortMenu.contains(e.target) && e.target.id!=='btnSort') sortMenu.style.display='none';
    });
    sortMenu.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        state.sort = a.dataset.sort;
        sortMenu.style.display='none';
        fetchResults();
      });
    });

    $('#btnArea').addEventListener('click', ()=> showToast('ฟีเจอร์ย่าน/พื้นที่ - เร็วๆ นี้'));

    $('#backdrop').addEventListener('click', ()=>{
      closeDrawer('#drawerFilters'); closeDrawer('#drawerPrice');
    });

    // Init
    updatePriceChip();
    fetchResults();
  </script>
</body>
</html>
