<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ผลการค้นหาโรงแรม | Click & Go</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .title{font-size:clamp(20px,3vw,28px);font-weight:800;margin:8px 0 6px}
    .sub{color:#555;margin:0 0 12px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(3,1fr)}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:620px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;box-shadow:0 1px 10px rgba(0,0,0,.05);display:flex;flex-direction:column}
    .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:#f4f4f4}
    .body{padding:12px}
    .hname{margin:0 0 4px;font-weight:800}
    .meta{color:#666;font-size:13px}
    .foot{display:flex;justify-content:space-between;align-items:center;padding:0 12px 12px;margin-top:auto}
    .price{font-weight:800}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#0ea5a0;color:#fff;text-decoration:none}
    .muted{color:#888}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <a href="index.html" class="brand"><img src="logo.png" width="36" height="36" alt=""/> <strong>Click & Go</strong></a>
      <nav class="main-nav"><a href="index.html">หน้าแรก</a> <a href="deals.html">โปรโมชั่น</a></nav>
    </div>
  </header>

  <main class="wrap">
    <h1 class="title">ผลการค้นหาโรงแรม</h1>
    <p id="summary" class="sub">กำลังโหลด...</p>
    <section id="grid" class="grid"></section>
  </main>

  <script>
    const $ = s => document.querySelector(s);

    // แผนที่ชื่อเมืองยอดฮิต -> cityId ของ Agoda
    const CITY_MAP = {
      bangkok: 9395, 'กรุงเทพ': 9395,
      'chiang mai': 9397, 'เชียงใหม่': 9397,
      pattaya: 9398, 'พัทยา': 9398,
      phuket: 9396, 'ภูเก็ต': 9396,
      krabi: 7023, 'กระบี่': 7023,
      'hua hin': 11278, 'หัวหิน': 11278,
      tokyo: 6419, seoul: 14690, singapore: 11419, 'hong kong': 4543, london: 17072, paris: 16808
    };

    // อ่านพารามิเตอร์จาก URL
    const p = new URLSearchParams(location.search);
    const q         = (p.get('q') || 'Bangkok').trim();
    const cityid    = parseInt(p.get('cityid') || '', 10) || CITY_MAP[(q||'').toLowerCase()] || 9395;
    const checkin   = p.get('checkin')  || new Date().toISOString().slice(0,10);
    const checkout  = p.get('checkout') || new Date(Date.now()+86400000).toISOString().slice(0,10);
    const rooms     = +(p.get('rooms') || 1);
    const adults    = +(p.get('adults') || 2);
    const children  = +(p.get('children') || 0);
    const currency  = (p.get('currency') || 'USD').toUpperCase();

    $('#summary').textContent =
      `${q} | วันที่: ${checkin} → ${checkout} | ผู้เข้าพัก: ${adults} ผู้ใหญ่, ${children} เด็ก, ${rooms} ห้อง`;

    async function load() {
      const qs = new URLSearchParams({
        cityid, checkin, checkout, rooms, adults, children, currency,
        sort: 'PriceAsc', max: '30'
      });
      const res = await fetch(`/api/search?${qs.toString()}`, { headers: { 'Accept': 'application/json' }});
      const data = await res.json();
      render(data.items || []);
    }

    function render(items) {
      const grid = $('#grid');
      if (!items.length) {
        grid.innerHTML = `<div class="muted">ไม่พบรายการที่ตรงเงื่อนไข</div>`;
        return;
      }
      grid.innerHTML = items.map(card).join('');
    }

    function card(h) {
      const stars = '★'.repeat(h.starRating || 0);
      const review = (h.reviewScore != null) ? ` · คะแนน ${h.reviewScore}` : '';
      const price = (h.priceFrom != null) ? `${Number(h.priceFrom).toLocaleString()} ${h.currency || ''}` : '-';
      return `
        <article class="card">
          <img class="thumb" src="${h.imageUrl || 'https://picsum.photos/800/450?blur=2'}" alt="${h.name || ''}" loading="lazy">
          <div class="body">
            <h3 class="hname">${h.name || '-'}</h3>
            <div class="meta">${stars}${review}</div>
          </div>
          <div class="foot">
            <div class="price">${price}</div>
            <a class="btn" href="${h.deeplink || '#'}" target="_blank" rel="nofollow noopener">ดูดีล</a>
          </div>
        </article>`;
    }

    load();
  </script>
</body>
</html>
