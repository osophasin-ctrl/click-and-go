<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ค้นหาโรงแรม | Click & Go</title>
  <meta name="description" content="ผลการค้นหาโรงแรมด้วยตัวกรองและปุ่มโหลดเพิ่มเติม (Load more) – Click & Go">
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* --- Search Results + Filters --- */
    .results-wrap{ display:grid; grid-template-columns: 260px 1fr; gap:16px; margin-top:16px; }
    .filter-card{
      border:1px solid #e5e5e5; background:#fff; border-radius:12px; padding:14px;
      position:sticky; top:10px; height:max-content;
    }
    .filter-card h3{ margin:0 0 8px; font-size:18px; }
    .filter-block{ margin-bottom:12px; }
    .filter-block label{ display:block; font-weight:700; margin-bottom:6px; }
    .filter-inline{ display:flex; gap:8px; }
    .filter-inline input{ width:100%; }

    .select, .text, .num, .btn{
      height:40px; border:1px solid #ddd; border-radius:8px; padding:0 10px;
      background:#fff; font-size:14px;
    }
    .btn{ background:#0ea5a0; color:#fff; font-weight:700; border:0; cursor:pointer; }
    .btn-outline{ background:#fff; color:#333; border:1px solid #bbb; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .result-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:6px 0 8px; }
    .result-head .meta{ color:#666; font-size:14px; }

    .list{ display:grid; gap:14px; }
    .card{
      display:grid; grid-template-columns: 180px 1fr 140px; gap:12px; align-items:center;
      border:1px solid #eee; background:#fff; border-radius:12px; padding:10px;
    }
    .thumb{ width:100%; aspect-ratio:1.2/1; object-fit:cover; border-radius:10px; background:#f1f1f1; }
    .hotel h3{ margin:0 0 6px; font-size:18px; }
    .hotel .sub{ color:#666; font-size:14px; }
    .stars{ color:#f5a524; letter-spacing:1px; margin-left:4px; }
    .score{ font-weight:700; color:#0b8e78; margin-left:8px; }
    .price{ text-align:right; }
    .price .p{ font-weight:800; font-size:18px; }
    .meta-badges{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;}
    .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eefaf9; color:#0b8e78; border:1px solid #bfe9e2; }
    .actions{ margin-top:6px; text-align:right; }
    .empty{ text-align:center; padding:40px 10px; color:#666; }
    .loadmore{ display:flex; justify-content:center; margin:16px 0; }

    @media (max-width: 980px){
      .results-wrap{ grid-template-columns: 1fr; }
      .card{ grid-template-columns: 120px 1fr; }
      .price{ grid-column: 1 / -1; text-align:left; }
      .actions{ text-align:left; }
    }
  </style>
</head>
<body>
  <!-- Header (ใช้สไตล์จาก style.css เดิม) -->
  <header class="site-header" role="banner">
    <div class="inner">
      <a href="/index.html" class="brand" aria-label="Click & Go">
        <img src="/logo.png" alt="Click & Go" width="40" height="40" loading="lazy" />
        <span class="brand-text" aria-hidden="true">Click & Go</span>
      </a>
      <nav class="main-nav" aria-label="เมนูหลัก">
        <a href="/index.html">หน้าแรก</a>
        <a href="/deals.html">โปรโมชั่น</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 class="section-title">ผลการค้นหาโรงแรม</h1>

    <!-- param summary -->
    <div id="summary" class="muted"></div>

    <div class="results-wrap">
      <!-- FILTERS -->
      <aside class="filter-card" aria-label="ตัวกรองผลการค้นหา">
        <h3>ตัวกรอง</h3>

        <div class="filter-block">
          <label>เรียงลำดับ</label>
          <select id="f-sort" class="select">
            <option value="PRICE">ราคาต่ำ → สูง</option>
            <option value="RATING">คะแนนรีวิวสูง → ต่ำ</option>
            <option value="STARS">จำนวนดาวสูง → ต่ำ</option>
          </select>
        </div>

        <div class="filter-block">
          <label>ช่วงราคา (THB)</label>
          <div class="filter-inline">
            <input id="f-pmin" class="num" type="number" inputmode="numeric" placeholder="ต่ำสุด">
            <input id="f-pmax" class="num" type="number" inputmode="numeric" placeholder="สูงสุด">
          </div>
        </div>

        <div class="filter-block">
          <label>จำนวนดาว</label>
          <div>
            <label><input type="checkbox" class="f-star" value="5"> 5★</label><br>
            <label><input type="checkbox" class="f-star" value="4"> 4★</label><br>
            <label><input type="checkbox" class="f-star" value="3"> 3★</label>
          </div>
        </div>

        <div class="filter-block">
          <label>คะแนนรีวิวขั้นต่ำ</label>
          <select id="f-rating" class="select">
            <option value="">ไม่กำหนด</option>
            <option value="9">9.0+</option>
            <option value="8.5">8.5+</option>
            <option value="8">8.0+</option>
            <option value="7.5">7.5+</option>
          </select>
        </div>

        <div class="filter-block">
          <label>สิ่งอำนวยความสะดวก</label>
          <label><input type="checkbox" id="f-freecancel"> ยกเลิกฟรี</label><br>
          <label><input type="checkbox" id="f-breakfast"> อาหารเช้า</label>
        </div>

        <div class="filter-block">
          <button id="btnApply" class="btn" style="width:100%">ปรับใช้ตัวกรอง</button>
          <button id="btnReset" class="btn btn-outline" style="width:100%; margin-top:8px">ล้างตัวกรอง</button>
        </div>
      </aside>

      <!-- LIST -->
      <section>
        <div class="result-head">
          <div class="meta" id="metaCount"></div>
          <div>
            <select id="pageSize" class="select">
              <option value="10">แสดง 10 รายการ</option>
              <option value="20" selected>แสดง 20 รายการ</option>
              <option value="30">แสดง 30 รายการ (สูงสุด)</option>
            </select>
          </div>
        </div>

        <div id="list" class="list" role="list"></div>
        <div id="empty" class="empty" hidden>ไม่พบผลลัพธ์ตามตัวกรองที่เลือก</div>

        <div class="loadmore">
          <button id="btnLoadMore" class="btn" hidden>แสดงเพิ่มเติม</button>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container" style="text-align:center">
      <div class="footer-links">
        <a href="/privacy.html">Privacy</a> ·
        <a href="/terms.html">Terms</a> ·
        <a href="/affiliate.html">Affiliate Disclosure</a> ·
        <a href="/about.html">About us</a> ·
        <a href="/contact.html">Contact</a>
      </div>
    </div>
  </footer>

  <script>
    // ---------- helper ----------
    function qs(name, def='') {
      const u = new URL(location.href);
      return u.searchParams.get(name) || def;
    }
    function esc(s){ return String(s || '').replace(/[&<>'"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }
    function formatPrice(n){ return (Number(n)||0).toLocaleString('th-TH'); }
    function starStr(n){ n = Number(n)||0; return '★'.repeat(Math.round(n)); }

    // ---------- state ----------
    const state = {
      q: qs('q','Bangkok'),
      checkin: qs('checkin'),
      checkout: qs('checkout'),
      rooms: qs('rooms','1'),
      adults: qs('adults','2'),
      children: qs('children','0'),

      sort: 'PRICE',
      priceMin: '',
      priceMax: '',
      stars: [],
      ratingMin: '',
      freeCancel: false,
      breakfast: false,

      page: 1,
      pageSize: 20,
      loading: false,
      hasMore: false,
      total: 0
    };

    // ---------- bind UI ----------
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const metaCount = document.getElementById('metaCount');
    const btnLoadMore = document.getElementById('btnLoadMore');

    const fSort = document.getElementById('f-sort');
    const fPmin = document.getElementById('f-pmin');
    const fPmax = document.getElementById('f-pmax');
    const fRating = document.getElementById('f-rating');
    const fFree = document.getElementById('f-freecancel');
    const fBkf = document.getElementById('f-breakfast');
    const fStars = Array.from(document.querySelectorAll('.f-star'));
    const pageSizeEl = document.getElementById('pageSize');

    // summary
    const summary = document.getElementById('summary');
    summary.textContent =
      `${esc(state.q)} | วันที่: ${esc(state.checkin)} → ${esc(state.checkout)} | ผู้เข้าพัก: ${esc(state.adults)} ผู้ใหญ่, ${esc(state.children)} เด็ก, ${esc(state.rooms)} ห้อง`;

    // default UI
    fSort.value = state.sort;
    pageSizeEl.value = String(state.pageSize);

    // ---------- render ----------
    function renderItems(items) {
      const cid = '1949420'; // ใช้ CID ของคุณ (สำหรับทำ deeplink fallback)
      const html = items.map(h=>{
        const link = h.deeplink ||
          `https://www.agoda.com/partners/partnersearch.aspx?cid=${encodeURIComponent(cid)}&city=${encodeURIComponent(state.q)}&checkIn=${encodeURIComponent(state.checkin)}&checkOut=${encodeURIComponent(state.checkout)}`;
        return `
          <article class="card" role="listitem">
            <img class="thumb" src="${esc(h.imageUrl)}" alt="${esc(h.name)}" loading="lazy"/>
            <div class="hotel">
              <h3>${esc(h.name)}</h3>
              <div class="sub">${esc(h.city || '')}
                <span class="stars">${starStr(h.starRating)}</span>
                <span class="score">${(h.reviewScore||'') ? esc(h.reviewScore) : ''}</span>
              </div>
              <div class="meta-badges">
                ${h.freeCancellation ? '<span class="badge">Free cancellation</span>' : ''}
                ${h.mealPlan ? '<span class="badge">'+esc(h.mealPlan)+'</span>' : ''}
              </div>
            </div>
            <div class="price">
              <div class="p">${formatPrice(h.priceFrom)} ${esc(h.currency||'THB')}</div>
              <div class="actions">
                <a href="${link}" class="btn" target="_blank" rel="nofollow noopener">ดูดีล</a>
              </div>
            </div>
          </article>
        `;
      }).join('');
      listEl.insertAdjacentHTML('beforeend', html);
    }

    function setMeta(total, page, pageSize) {
      if (total === 0) {
        metaCount.textContent = 'ไม่พบผลลัพธ์';
      } else {
        const start = (page-1)*pageSize + 1;
        const end = Math.min(total, page*pageSize);
        metaCount.textContent = `แสดง ${start}–${end} จากทั้งหมด ${total} รายการ`;
      }
    }

    function resetList() {
      listEl.innerHTML = '';
      emptyEl.hidden = true;
      metaCount.textContent = '';
    }

    // ---------- fetch ----------
    async function fetchHotels({append=false} = {}) {
      if (state.loading) return;
      state.loading = true;
      btnLoadMore.disabled = true;

      const params = new URLSearchParams({
        q: state.q,
        checkin: state.checkin,
        checkout: state.checkout,
        rooms: state.rooms,
        adults: state.adults,
        children: state.children,
        page: String(state.page),
        pageSize: String(state.pageSize),
        sort: state.sort
      });

      if (state.priceMin) params.set('priceMin', state.priceMin);
      if (state.priceMax) params.set('priceMax', state.priceMax);
      if (state.ratingMin) params.set('ratingMin', state.ratingMin);
      if (state.freeCancel) params.set('freeCancel', 'true');
      if (state.breakfast) params.set('meal', 'Breakfast included');
      if (state.stars.length) params.set('stars', state.stars.join(','));

      try{
        const url = `/api/search?${params.toString()}`;
        const res = await fetch(url);
        const data = await res.json();

        state.hasMore = Boolean(data.hasMore);
        state.total = Number(data.total || 0);

        if (!append) resetList();
        if (data.items && data.items.length) {
          renderItems(data.items);
          emptyEl.hidden = true;
        } else if (!append) {
          emptyEl.hidden = false;
        }
        setMeta(state.total, state.page, state.pageSize);
        btnLoadMore.hidden = !state.hasMore;
        btnLoadMore.disabled = false;
      } catch(e){
        console.error(e);
        if (!append) {
          resetList();
          emptyEl.hidden = false;
          emptyEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
        }
        btnLoadMore.hidden = true;
      } finally {
        state.loading = false;
      }
    }

    // ---------- events ----------
    document.getElementById('btnLoadMore').addEventListener('click', ()=>{
      if (state.hasMore) {
        state.page += 1;
        fetchHotels({append:true});
      }
    });

    document.getElementById('btnApply').addEventListener('click', ()=>{
      state.sort = fSort.value;
      state.priceMin = fPmin.value.trim();
      state.priceMax = fPmax.value.trim();
      state.ratingMin = fRating.value.trim();
      state.freeCancel = fFree.checked;
      state.breakfast = fBkf.checked;
      state.stars = fStars.filter(cb=>cb.checked).map(cb=>cb.value);

      state.page = 1;
      state.pageSize = Number(pageSizeEl.value || 20);
      fetchHotels({append:false});
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      fSort.value = 'PRICE';
      fPmin.value = ''; fPmax.value = '';
      fRating.value = ''; fFree.checked = false; fBkf.checked = false;
      fStars.forEach(cb=>cb.checked=false);
      pageSizeEl.value = '20';

      state.sort='PRICE'; state.priceMin=''; state.priceMax=''; state.ratingMin='';
      state.freeCancel=false; state.breakfast=false; state.stars=[];
      state.page=1; state.pageSize=20;
      fetchHotels({append:false});
    });

    pageSizeEl.addEventListener('change', ()=>{
      state.pageSize = Number(pageSizeEl.value || 20);
      state.page = 1;
      fetchHotels({append:false});
    });

    // ---------- initial load ----------
    fetchHotels({append:false});
  </script>
</body>
</html>
