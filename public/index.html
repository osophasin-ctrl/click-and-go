<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Click & Go — ค้นหาโรงแรม</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/style.css">
  <style>
    :root{--brand:#0aa297}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .hero{display:grid;gap:16px;grid-template-columns:1fr}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.07);padding:16px;border:1px solid #e8e8e8}
    .form-row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .form-row-3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    @media(max-width:640px){.form-row,.form-row-3{grid-template-columns:1fr}}
    .label{font-weight:700;margin:6px 0 4px}
    .inp{height:44px;border:1px solid #d7d7d7;border-radius:8px;padding:0 10px;background:#fff;font-size:16px;width:100%}
    .btn{height:46px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .suggest{position:relative}
    .suggest-list{position:absolute;z-index:10;left:0;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px;box-shadow:0 6px 20px rgba(0,0,0,.08);max-height:300px;overflow:auto;display:none}
    .suggest-list button{display:block;width:100%;text-align:left;padding:10px 12px;background:#fff;border:0;border-bottom:1px solid #f0f0f0;cursor:pointer}
    .suggest-list button:last-child{border-bottom:0}
    .muted{color:#666}
    .site-header .lang{position:relative}
    .lang button{height:36px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;padding:0 10px;cursor:pointer}
    .lang-menu{position:absolute;top:110%;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:none;min-width:160px}
    .lang-menu a{display:block;padding:10px 12px;text-decoration:none;color:#111}
    .lang-menu a:hover{background:#f6f6f6}
  </style>
</head>
<body>
<header class="site-header" role="banner">
  <div class="inner">
    <a href="/index.html" class="brand"><img src="/logo.png" width="40" height="40" alt="Click & Go"><span class="brand-text">Click & Go</span></a>
    <nav class="main-nav">
      <a href="/index.html">หน้าแรก</a>
      <a href="/deals.html">โปรโมชั่น</a>
    </nav>
    <div class="lang">
      <button id="langBtn" type="button">ภาษา ▾</button>
      <div id="langMenu" class="lang-menu" role="menu" aria-labelledby="langBtn">
        <a href="/index.html" role="menuitem">ไทย</a>
        <!-- ✅ ชี้ไป /en/index.html แก้ 404 -->
        <a href="/en/index.html" role="menuitem">English</a>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div class="card">
      <h1 style="margin:0 0 8px">ค้นหาโรงแรม</h1>
      <p class="muted" style="margin:0 0 14px">พิมพ์ชื่อโรงแรม เลือกวันที่ และจำนวนผู้เข้าพัก จากนั้นกดค้นหา</p>

      <form id="searchForm" action="/search.html" method="get" autocomplete="off">
        <div class="label">โรงแรม</div>
        <div class="suggest">
          <input id="qHotel" class="inp" type="text" placeholder="พิมพ์ชื่อโรงแรม เช่น Centara, Hilton, …">
          <div id="sugList" class="suggest-list" role="listbox" aria-label="คำแนะนำโรงแรม"></div>
        </div>

        <div class="form-row" style="margin-top:10px">
          <div>
            <div class="label">เช็คอิน</div>
            <input id="ci" name="checkin" class="inp" type="date">
          </div>
          <div>
            <div class="label">เช็คเอาท์</div>
            <input id="co" name="checkout" class="inp" type="date">
          </div>
        </div>

        <div class="form-row-3" style="margin-top:10px">
          <div>
            <div class="label">ผู้ใหญ่</div>
            <input id="adults" name="adults" class="inp" type="number" min="1" max="10" value="2">
          </div>
          <div>
            <div class="label">เด็ก</div>
            <input id="children" name="children" class="inp" type="number" min="0" max="10" value="0">
          </div>
          <div>
            <div class="label">ห้อง</div>
            <input id="rooms" name="rooms" class="inp" type="number" min="1" max="10" value="1">
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px">
          <button class="btn" type="submit" style="flex:1">ค้นหา</button>
          <a class="btn" href="/hotel-search.html" style="flex:1;display:inline-flex;align-items:center;justify-content:center;background:#12b981">หรือค้นหาจากชื่อโรงแรม</a>
        </div>

        <!-- ค่าแฝงเมื่อเลือกโรงแรมจาก autocomplete -->
        <input type="hidden" id="hid" name="hid" value="">
        <input type="hidden" name="lang" value="th-th">
      </form>
    </div>
  </section>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const ONE = 86400000;

  // ---------- Language dropdown ----------
  const langBtn = $('#langBtn'), langMenu = $('#langMenu');
  langBtn.addEventListener('click', ()=>{ langMenu.style.display = langMenu.style.display==='block'?'none':'block'; });
  document.addEventListener('click', (e)=>{
    if(!langMenu.contains(e.target) && e.target!==langBtn) langMenu.style.display='none';
  });

  // ---------- Dates default ----------
  const todayISO = d => new Date(d).toISOString().slice(0,10);
  const ci = $('#ci'), co = $('#co');
  const tCi = new Date();
  const tCo = new Date(Date.now()+ONE);
  ci.value = todayISO(tCi);
  co.value = todayISO(tCo);
  ci.min  = todayISO(new Date());
  co.min  = todayISO(new Date(tCi.getTime()+ONE));
  ci.addEventListener('change', ()=>{
    const a = new Date(ci.value || todayISO(new Date()));
    const n = new Date(a.getTime()+ONE);
    if (!co.value || new Date(co.value) <= a) co.value = todayISO(n);
    co.min = todayISO(n);
  });

  // ---------- Autocomplete (ใช้ /api/hotel-search?q=...&lang=th-th) ----------
  const box = $('#qHotel'), list = $('#sugList'), hid = $('#hid');
  let t = null;

  async function fx(url){
    try{
      const r = await fetch(url, {cache:'no-store'});
      return await r.json();
    }catch(_){ return {ok:false, items:[]}; }
  }

  function show(items){
    if(!items.length){ list.style.display='none'; list.innerHTML=''; return; }
    list.innerHTML = items.map(it => `<button type="button" data-hid="${it.hotel_id}">${it.label}</button>`).join('');
    list.style.display = 'block';
    list.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        box.value = b.textContent.trim();
        hid.value = b.getAttribute('data-hid') || '';
        list.style.display='none';
      });
    });
  }

  async function run(q){
    const v = String(q||'').trim();
    if(!v){ show([]); return; }
    const u = new URL('/api/hotel-search', location.origin);
    u.searchParams.set('q', v);
    u.searchParams.set('lang', 'th-th');   // สำคัญมาก: ให้ดึงดัชนีภาษาไทย
    u.searchParams.set('limit', '8');
    const d = await fx(u.toString());
    const items = (d && d.ok && Array.isArray(d.items)) ? d.items : [];
    show(items);
  }

  box.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(()=>run(box.value), 150);
  });
  box.addEventListener('focus', ()=>run(box.value));
  document.addEventListener('click', e=>{
    if(!list.contains(e.target) && e.target!==box){ list.style.display='none'; }
  });

  // ---------- Submit: ถ้าเลือกโรงแรมแล้วให้ไปหน้า search.html โหมด hotel ----------
  $('#searchForm').addEventListener('submit', (e)=>{
    if(hid.value){ // โหมดโรงแรม
      e.preventDefault();
      const qs = new URLSearchParams({
        hid: hid.value,
        checkin: ci.value,
        checkout: co.value,
        adults: $('#adults').value || '2',
        children: $('#children').value || '0',
        rooms: $('#rooms').value || '1',
        lang: 'th-th'
      });
      location.href = `/search.html?${qs.toString()}`;
    }
    // ถ้าไม่ได้เลือกโรงแรม ให้ปล่อย form ไปตาม action เดิม (คุณอาจจะอ่าน q= เมือง ส่วนนี้ไม่แตะ)
  });
})();
</script>
</body>
</html>
