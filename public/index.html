<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Click&Go — ค้นหาโรงแรม</title>
  <style>
    :root { --pri:#09a394; --muted:#8a8a8a; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;margin:0;color:#222;background:#fff}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e9ecef;border-radius:14px;padding:16px;margin:16px 0;box-shadow:0 1px 1px rgba(0,0,0,.02)}
    .title{font-size:22px;font-weight:800;margin:0 0 8px}
    .muted{color:#6b7280}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .input{width:100%;height:44px;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;font-size:16px}
    .btn{height:46px;border:0;border-radius:12px;padding:0 18px;background:var(--pri);color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;height:32px;border-radius:999px;padding:0 12px;background:#eef8f7;color:#075e55;font-weight:700}
    .ac-wrap{position:relative}
    .ac{position:absolute;left:0;right:0;top:48px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;z-index:50;max-height:300px;overflow-y:auto;box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .ac-group{padding:10px 12px;border-bottom:1px solid #f3f4f6;font-weight:800;color:#111}
    .ac-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-size:15px;cursor:pointer}
    .ac-item:hover{background:#f9fafb}
    .tag{color:#6b7280;font-size:12px;margin-left:12px}
    .hint{font-size:13px;color:#6b7280;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">ค้นหาโรงแรม</h1>
    <p class="muted">แยกกล่องชัดเจน: เลือกค้นหาตาม <b>เมือง</b> หรือค้นหาเฉพาะ <b>โรงแรม</b></p>

    <!-- ค้นหาตามเมือง -->
    <div class="card">
      <div class="title">ค้นหาตามเมือง</div>
      <div class="ac-wrap">
        <input id="city-input" class="input" placeholder="พิมพ์ชื่อเมือง เช่น กรุงเทพ เชียงใหม่ ฯลฯ" autocomplete="off" />
        <div id="city-ac" class="ac" hidden></div>
      </div>
      <div class="row-3" style="margin-top:12px">
        <div><label class="muted">เช็คอิน</label><input id="city-checkin" type="date" class="input"/></div>
        <div><label class="muted">เช็คเอาท์</label><input id="city-checkout" type="date" class="input"/></div>
        <div><label class="muted">ผู้เข้าพัก</label><input id="city-occupancy" class="input" value="2" /></div>
      </div>
      <div style="margin-top:12px"><button id="city-search" class="btn">ค้นหา (เมือง)</button></div>
      <div id="city-hint" class="hint"></div>
    </div>

    <!-- ค้นหาตามโรงแรม -->
    <div class="card">
      <div class="title">ค้นหาตามโรงแรม</div>
      <div class="ac-wrap">
        <input id="hotel-input" class="input" placeholder="พิมพ์ชื่อโรงแรม เช่น Centara, Hilton, ... " autocomplete="off" />
        <div id="hotel-ac" class="ac" hidden></div>
      </div>
      <div class="row-3" style="margin-top:12px">
        <div><label class="muted">เช็คอิน</label><input id="hotel-checkin" type="date" class="input"/></div>
        <div><label class="muted">เช็คเอาท์</label><input id="hotel-checkout" type="date" class="input"/></div>
        <div><label class="muted">ผู้เข้าพัก</label><input id="hotel-occupancy" class="input" value="2" /></div>
      </div>
      <div style="margin-top:12px"><button id="hotel-search" class="btn">ค้นหา (โรงแรม)</button></div>
      <div id="hotel-hint" class="hint"></div>
    </div>
  </div>

  <script>
    // -------- utils --------
    const fmtDate = (d) => d.toISOString().slice(0,10);
    const today = new Date();
    const tomorrow = new Date(Date.now() + 86400000);

    // set default dates
    document.getElementById('city-checkin').value = fmtDate(today);
    document.getElementById('city-checkout').value = fmtDate(tomorrow);
    document.getElementById('hotel-checkin').value = fmtDate(today);
    document.getElementById('hotel-checkout').value = fmtDate(tomorrow);

    const debounce = (fn, ms=250) => {
      let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }
    };
    const norm = s => (s||'').normalize('NFKC').trim().toLowerCase();

    function renderAcList({container, header, items, itemRender, emptyText}) {
      container.innerHTML = '';
      const head = document.createElement('div');
      head.className = 'ac-group';
      head.textContent = header;
      container.appendChild(head);

      if (!items || items.length === 0) {
        const it = document.createElement('div');
        it.className = 'ac-item';
        it.textContent = emptyText || 'ไม่พบคำแนะนำ';
        container.appendChild(it);
        return;
      }
      items.forEach((x) => {
        const row = document.createElement('div');
        row.className = 'ac-item';
        row.innerHTML = itemRender(x);
        row.addEventListener('click', () => x._onSelect && x._onSelect(x));
        container.appendChild(row);
      });
    }

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // --------- CITY AUTOCOMPLETE ----------
    const cityState = { id:null, name:null };
    const cityInput = document.getElementById('city-input');
    const cityAc = document.getElementById('city-ac');
    const cityHint = document.getElementById('city-hint');

    const citySuggest = debounce(async () => {
      const q = cityInput.value.trim();
      if (q.length < 2) {
        cityAc.hidden = true;
        cityState.id = null; cityState.name = null;
        return;
      }
      cityAc.hidden = false;
      renderAcList({
        container: cityAc,
        header: 'เมือง',
        items: [],
        emptyText: 'กำลังค้นหา…'
      });

      try {
        const res = await fetchJSON(`/api/city-suggest?q=${encodeURIComponent(q)}&lang=th&limit=20`);
        const items = (res?.items||[]).map((it)=>({
          ...it,
          _onSelect: (x)=>{
            cityState.id = x.id || x.cityId;
            cityState.name = x.name || x.cityName;
            cityInput.value = x.name || x.cityName || '';
            cityAc.hidden = true;
          }
        }));
        renderAcList({
          container: cityAc,
          header: 'เมือง',
          items,
          itemRender: (x)=>`
            <div>${x.name || x.cityName || ''}</div>
            <div class="tag">เมือง</div>
          `,
          emptyText: 'ไม่พบคำแนะนำ'
        });
      } catch(e) {
        renderAcList({container: cityAc, header:'เมือง', items:[], emptyText:'ไม่พบคำแนะนำ'});
      }
    }, 300);

    cityInput.addEventListener('input', citySuggest);
    document.addEventListener('click', (e)=>{
      if (!cityAc.contains(e.target) && e.target!==cityInput) cityAc.hidden = true;
      if (!hotelAc.contains(e.target) && e.target!==hotelInput) hotelAc.hidden = true;
    });

    document.getElementById('city-search').addEventListener('click', ()=>{
      const cityId = cityState.id;
      const cityName = cityState.name || cityInput.value.trim();
      if (!cityId && !cityName) {
        cityHint.textContent = 'โปรดพิมพ์และเลือกเมืองจากรายการแนะนำ';
        return;
      }
      const checkIn = document.getElementById('city-checkin').value;
      const checkOut = document.getElementById('city-checkout').value;
      const adults = (document.getElementById('city-occupancy').value||'2').trim();

      const usp = new URLSearchParams({
        mode:'city',
        cityId: cityId || '',
        cityName,
        checkIn, checkOut,
        adults, rooms:'1', children:'0'
      });

      // โหมดเมือง: เคลียร์คีย์โรงแรม
      ['hotelId','hotelName'].forEach(k=>usp.delete(k));

      location.href = `/search?${usp.toString()}`;
    });

    // --------- HOTEL AUTOCOMPLETE ----------
    const hotelState = { id:null, name:null, cityId:null };
    const hotelInput = document.getElementById('hotel-input');
    const hotelAc = document.getElementById('hotel-ac');
    const hotelHint = document.getElementById('hotel-hint');

    const hotelSuggest = debounce(async ()=>{
      const q = hotelInput.value.trim();
      if (q.length < 2) { hotelAc.hidden=true; hotelState.id=null; hotelState.name=null; hotelState.cityId=null; return; }
      hotelAc.hidden=false;
      renderAcList({container:hotelAc, header:'โรงแรม', items:[], emptyText:'กำลังค้นหา…'});

      try{
        const res = await fetchJSON(`/api/hotel-suggest?q=${encodeURIComponent(q)}&lang=th&limit=20`);
        const items = (res?.items||[]).map((it)=>({
          ...it,
          _onSelect:(x)=>{
            hotelState.id = x.id || x.hotelId;
            hotelState.name = x.name || x.hotelName;
            hotelState.cityId = x.cityId || x.agodaCityId || x.city?.id || null;
            hotelInput.value = x.name || x.hotelName || '';
            hotelAc.hidden = true;
          }
        }));
        renderAcList({
          container: hotelAc,
          header: 'โรงแรม',
          items,
          itemRender:(x)=>`
            <div>${x.name || x.hotelName || ''}</div>
            <div class="tag">โรงแรม</div>
          `,
          emptyText:'ไม่พบคำแนะนำ'
        });
      }catch(e){
        renderAcList({container:hotelAc, header:'โรงแรม', items:[], emptyText:'ไม่พบคำแนะนำ'});
      }
    },300);

    hotelInput.addEventListener('input', hotelSuggest);

    document.getElementById('hotel-search').addEventListener('click', ()=>{
      if (!hotelState.id && !hotelState.name){
        hotelHint.textContent = 'โปรดพิมพ์และเลือกโรงแรมจากรายการแนะนำ';
        return;
      }
      const checkIn = document.getElementById('hotel-checkin').value;
      const checkOut = document.getElementById('hotel-checkout').value;
      const adults = (document.getElementById('hotel-occupancy').value||'2').trim();

      const usp = new URLSearchParams({
        mode:'hotel',
        cityId: hotelState.cityId || '',
        hotelId: hotelState.id || '',
        hotelName: hotelState.name || '',
        checkIn, checkOut,
        adults, rooms:'1', children:'0'
      });

      location.href = `/search?${usp.toString()}`;
    });
  </script>
</body>
</html>
