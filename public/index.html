<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Click & Go — ค้นหาโรงแรม</title>
  <style>
    :root{
      --teal:#0d9488;       /* ปุ่มเขียวเดิม */
      --teal-dark:#0b7d73;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --bg:#ffffff;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:16px;
      --radius-sm:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:#f8fafc;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:960px;margin:0 auto;padding:20px}
    .card{
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    h2{margin:0 0 6px;font-size:22px;font-weight:800}
    p.lead{margin:0 0 16px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media(min-width:640px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .input{
      height:48px;width:100%;
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:0 12px;
      font-size:16px; outline: none;
      background:#fff;
    }
    label{display:block;margin:6px 0 6px;color:var(--muted);font-size:14px}
    .btn{
      height:48px;width:100%;
      background:var(--teal);color:#fff;
      border:none;border-radius:var(--radius-sm);
      font-weight:800;font-size:16px;cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:var(--teal-dark)}
    .ac{
      position:relative
    }
    .ac-list{
      position:absolute;left:0;right:0;top:52px;
      background:#fff;border:1px solid var(--border);
      border-radius:14px;box-shadow:var(--shadow);
      max-height:280px;overflow:auto;z-index:50
    }
    .ac-head{padding:8px 12px;border-bottom:1px solid var(--border);font-weight:800}
    .ac-item{
      display:flex;justify-content:space-between;align-items:center;
      width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;cursor:pointer
    }
    .ac-item:hover{background:#f9fafb}
    .muted{color:var(--muted);font-size:14px}
    .hidden{display:none}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid var(--border);border-radius:999px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    @media(max-width:639px){.row{grid-template-columns:1fr 1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <section class="card">
      <h2>ค้นหาดีลที่ใช่สำหรับคุณ</h2>
      <p class="lead">พิมพ์ชื่อ<strong>เมือง</strong> หรือ <strong>โรงแรม</strong> เลือกวันที่ ระบุผู้เข้าพัก แล้วกดค้นหา</p>

      <!-- 2 กล่อง: เมือง | โรงแรม -->
      <div class="grid grid-2">
        <!-- เมือง -->
        <div class="ac" id="cityBox">
          <input id="cityInput" class="input" placeholder="พิมพ์ชื่อเมือง" autocomplete="off" />
          <div id="cityList" class="ac-list hidden" role="listbox" aria-label="เมือง">
            <div class="ac-head">เมือง</div>
            <div id="cityContent"></div>
          </div>
        </div>

        <!-- โรงแรม -->
        <div class="ac" id="hotelBox">
          <input id="hotelInput" class="input" placeholder="พิมพ์ชื่อโรงแรม" autocomplete="off" />
          <div id="hotelList" class="ac-list hidden" role="listbox" aria-label="โรงแรม">
            <div class="ac-head">โรงแรม</div>
            <div id="hotelContent"></div>
          </div>
        </div>
      </div>

      <!-- วันที่ / ผู้เข้าพัก -->
      <div class="grid grid-3" style="margin-top:12px">
        <div>
          <label for="checkIn">เช็คอิน</label>
          <input type="date" id="checkIn" class="input" />
        </div>
        <div>
          <label for="checkOut">เช็คเอาท์</label>
          <input type="date" id="checkOut" class="input" />
        </div>
        <div>
          <label>ผู้เข้าพัก</label>
          <div class="row">
            <input type="number" min="1" id="rooms" class="input" placeholder="ห้อง" title="จำนวนห้อง" />
            <input type="number" min="1" id="adults" class="input" placeholder="ผู้ใหญ่" title="ผู้ใหญ่" />
            <input type="number" min="0" id="children" class="input" placeholder="เด็ก" title="เด็ก" />
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <button class="btn" id="searchBtn">ค้นหา</button>
      </div>
    </section>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const todayISO = new Date().toISOString().slice(0,10);
    const tomorrowISO = new Date(Date.now()+86400000).toISOString().slice(0,10);
    $("#checkIn").value = todayISO;
    $("#checkOut").value = tomorrowISO;
    $("#rooms").value = 1;
    $("#adults").value = 2;
    $("#children").value = 0;

    const debounce = (fn, ms=300) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }
    };

    async function fetchJSON(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    }

    function showLoading(target){
      target.innerHTML = '<div class="muted" style="padding:12px">กำลังค้นหา…</div>';
    }
    function showEmpty(target){
      target.innerHTML = '<div class="muted" style="padding:12px">ไม่พบคำแนะนำ</div>';
    }

    // ---------- state ----------
    let selectedCity = null;   // {id,name}
    let selectedHotel = null;  // {id,name,cityId}

    // ---------- city autocomplete ----------
    const cityInput = $("#cityInput");
    const cityList = $("#cityList");
    const cityContent = $("#cityContent");
    function openCityList(){ cityList.classList.remove("hidden"); }
    function closeCityList(){ cityList.classList.add("hidden"); }

    const runCitySuggest = async (q)=>{
      if(!q || q.trim().length<2){ cityContent.innerHTML=''; showEmpty(cityContent); openCityList(); return; }
      openCityList(); showLoading(cityContent);
      try{
        const data = await fetchJSON(`/api/city-suggest?q=${encodeURIComponent(q)}&lang=th&limit=20`);
        const items = (data.items||[]).map(it=>({ id: it.id || it.cityId, name: it.name || it.cityName }));
        if(items.length===0){ showEmpty(cityContent); return; }
        cityContent.innerHTML = items.map(it =>
          `<button type="button" class="ac-item" data-id="${it.id}" data-name="${it.name}">
             <span class="truncate">${it.name}</span><span class="muted">เมือง</span>
           </button>`
        ).join("");
      }catch(e){
        showEmpty(cityContent);
      }
    };
    const citySuggest = debounce(runCitySuggest, 300);

    cityInput.addEventListener("input", e=>{
      selectedCity = null;
      citySuggest(e.target.value);
    });
    cityInput.addEventListener("focus", ()=>{ if(cityContent.innerHTML) openCityList(); });

    cityContent.addEventListener("click", e=>{
      const btn = e.target.closest("button.ac-item");
      if(!btn) return;
      selectedCity = { id: btn.dataset.id, name: btn.dataset.name };
      cityInput.value = selectedCity.name;
      closeCityList();
    });

    // ---------- hotel autocomplete ----------
    const hotelInput = $("#hotelInput");
    const hotelList = $("#hotelList");
    const hotelContent = $("#hotelContent");
    function openHotelList(){ hotelList.classList.remove("hidden"); }
    function closeHotelList(){ hotelList.classList.add("hidden"); }

    const runHotelSuggest = async (q)=>{
      if(!q || q.trim().length<2){ hotelContent.innerHTML=''; showEmpty(hotelContent); openHotelList(); return; }
      openHotelList(); showLoading(hotelContent);
      try{
        const data = await fetchJSON(`/api/hotel-suggest?q=${encodeURIComponent(q)}&lang=th&limit=20`);
        const items = (data.items||[]).map(it=>({
          id: it.id || it.hotelId,
          name: it.name || it.hotelName,
          cityId: it.cityId || it.agodaCityId || (it.city&&it.city.id) || ""
        }));
        if(items.length===0){ showEmpty(hotelContent); return; }
        hotelContent.innerHTML = items.map(it =>
          `<button type="button" class="ac-item"
                   data-id="${it.id}" data-name="${it.name}" data-city="${it.cityId}">
             <span class="truncate">${it.name}</span><span class="muted">โรงแรม</span>
           </button>`
        ).join("");
      }catch(e){
        showEmpty(hotelContent);
      }
    };
    const hotelSuggest = debounce(runHotelSuggest, 300);

    hotelInput.addEventListener("input", e=>{
      selectedHotel = null;
      hotelSuggest(e.target.value);
    });
    hotelInput.addEventListener("focus", ()=>{ if(hotelContent.innerHTML) openHotelList(); });

    hotelContent.addEventListener("click", e=>{
      const btn = e.target.closest("button.ac-item");
      if(!btn) return;
      selectedHotel = { id: btn.dataset.id, name: btn.dataset.name, cityId: btn.dataset.city || "" };
      hotelInput.value = selectedHotel.name;
      closeHotelList();
    });

    // ปิดลิสต์เมื่อคลิกรอบนอก
    document.addEventListener("click", (e)=>{
      if(!$("#cityBox").contains(e.target)) closeCityList();
      if(!$("#hotelBox").contains(e.target)) closeHotelList();
    });

    // ---------- search ----------
    $("#searchBtn").addEventListener("click", ()=>{
      const params = new URLSearchParams({
        checkIn: $("#checkIn").value,
        checkOut: $("#checkOut").value,
        rooms: String($("#rooms").value || 1),
        adults: String($("#adults").value || 2),
        children: String($("#children").value || 0),
      });

      if(selectedHotel){ // ให้โรงแรมสำคัญกว่า
        params.set("mode","hotel");
        params.set("hotelId", selectedHotel.id || "");
        params.set("hotelName", selectedHotel.name || "");
        if(selectedHotel.cityId) params.set("cityId", selectedHotel.cityId);
        window.location.href = `/search?${params.toString()}`;
        return;
      }

      if(selectedCity || cityInput.value.trim()){
        params.set("mode","city");
        if(selectedCity && selectedCity.id) params.set("cityId", selectedCity.id);
        params.set("cityName", (selectedCity ? selectedCity.name : cityInput.value).trim());
        window.location.href = `/search?${params.toString()}`;
        return;
      }

      alert("โปรดพิมพ์และเลือกเมืองหรือโรงแรมก่อนค้นหา");
    });
  </script>
</body>
</html>
