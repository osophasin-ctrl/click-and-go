<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ค้นหาจากชื่อโรงแรม | Click & Go</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    :root{--brand:#0aa297;--muted:#666}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .box{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:16px}
    .title{font-size:28px;margin:6px 0 12px}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .grid .full{grid-column:1 / -1}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-weight:600}
    .inp,.btn{height:44px;border:1px solid #d7d7d7;border-radius:8px;padding:0 12px;background:#fff;font-size:15px}
    .btn{background:var(--brand);color:#fff;border:0;cursor:pointer;font-weight:700}
    .muted{color:var(--muted)}
    .guest{display:flex;align-items:center;justify-content:space-between;border:1px solid #d7d7d7;border-radius:8px;padding:0 12px;height:44px;background:#fff}
    .ctrl{display:flex;align-items:center;gap:10px}
    .cbtn{width:32px;height:32px;border-radius:50%;border:1px solid #bbb;background:#fff;font-size:18px;cursor:pointer}
    .ctxt{min-width:20px;text-align:center;font-weight:700}
    .cta-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    /* Suggest */
    .suggest{position:relative}
    .panel{position:absolute;left:0;right:0;top:calc(100% + 4px);background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.08);max-height:260px;overflow:auto;z-index:30;display:none}
    .item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;gap:10px}
    .item:hover{background:#f7f7f7}
    .group{padding:8px 12px;font-weight:700;color:#6b7280;background:#fafafa;border-top:1px solid #f3f4f6}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <a href="/index.html" class="brand"><img src="/logo.png" width="40" height="40" alt="Click & Go"><span class="brand-text">Click & Go</span></a>
      <nav class="main-nav">
        <a href="/index.html">หน้าแรก</a>
        <a href="/deals.html">โปรโมชั่น</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1 class="title">ค้นหาจากชื่อโรงแรม</h1>
    <p class="muted" style="margin:-6px 0 12px">พิมพ์ชื่อโรงแรม เลือกวันที่ และจำนวนผู้เข้าพัก จากนั้นกดค้นหา</p>

    <section class="box">
      <form id="f" class="grid" autocomplete="off">
        <!-- โรงแรม -->
        <div class="field full suggest">
          <label class="label" for="q">ชื่อโรงแรม</label>
          <input id="q" class="inp" type="text" placeholder="เช่น Carlton Bangkok Sukhumvit" aria-label="ชื่อโรงแรม">
          <div id="panel" class="panel" role="listbox" aria-label="คำแนะนำโรงแรม"></div>
        </div>

        <!-- วันที่ -->
        <div class="field">
          <label class="label" for="ci">เช็คอิน</label>
          <input id="ci" class="inp" type="date">
        </div>
        <div class="field">
          <label class="label" for="co">เช็คเอาท์</label>
          <input id="co" class="inp" type="date">
        </div>

        <!-- ผู้เข้าพัก -->
        <div class="field full">
          <label class="label">ผู้เข้าพัก</label>
          <div class="guest">
            <div>ห้อง <span id="gRooms" class="ctxt">1</span> · ผู้ใหญ่ <span id="gAdults" class="ctxt">2</span> · เด็ก <span id="gChildren" class="ctxt">0</span></div>
          </div>
          <div class="ctrl" style="margin-top:8px;justify-content:space-between">
            <div class="ctrl"><span>ห้อง</span><button class="cbtn" data-t="rooms" data-op="-">−</button><span id="cRooms" class="ctxt">1</span><button class="cbtn" data-t="rooms" data-op="+">+</button></div>
            <div class="ctrl"><span>ผู้ใหญ่</span><button class="cbtn" data-t="adults" data-op="-">−</button><span id="cAdults" class="ctxt">2</span><button class="cbtn" data-t="adults" data-op="+">+</button></div>
            <div class="ctrl"><span>เด็ก</span><button class="cbtn" data-t="children" data-op="-">−</button><span id="cChildren" class="ctxt">0</span><button class="cbtn" data-t="children" data-op="+">+</button></div>
          </div>
        </div>

        <!-- ปุ่ม -->
        <div class="field full cta-row">
          <button class="btn" type="submit">ค้นหา</button>
          <a id="agodaLink" class="btn" href="#" target="_blank" rel="nofollow noopener" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">ไปยังหน้าโรงแรมที่พันธมิตร</a>
        </div>

        <!-- hidden -->
        <input type="hidden" id="hid">
        <input type="hidden" id="cityId">
        <input type="hidden" id="hotelName">
      </form>
    </section>
  </main>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const ONE = 86400000;

    // init date
    const today = new Date();
    const tomorrow = new Date(Date.now()+ONE);
    const iso = d => new Date(d).toISOString().slice(0,10);
    const ci = $('#ci'), co=$('#co');
    ci.value = iso(today); ci.min = iso(today);
    co.value = iso(tomorrow); co.min = iso(tomorrow);
    ci.addEventListener('change', ()=>{
      const a = new Date(ci.value||iso(today));
      const n = new Date(a.getTime()+ONE);
      if (!co.value || new Date(co.value) <= a){ co.value = iso(n); }
      co.min = iso(n);
    });

    // guests
    let rooms=1, adults=2, children=0;
    const syncGuest = ()=>{
      $('#cRooms').textContent = rooms; $('#gRooms').textContent = rooms;
      $('#cAdults').textContent = adults; $('#gAdults').textContent = adults;
      $('#cChildren').textContent = children; $('#gChildren').textContent = children;
    };
    syncGuest();
    document.querySelectorAll('.cbtn').forEach(b=>{
      b.addEventListener('click',(e)=>{
        e.preventDefault();
        const t=b.getAttribute('data-t'), op=b.getAttribute('data-op');
        const lim={rooms:[1,10],adults:[1,10],children:[0,10]}[t];
        let cur = {rooms,adults,children}[t];
        cur = op==='+'? Math.min(lim[1],cur+1) : Math.max(lim[0],cur-1);
        ({rooms,adults,children}[t]=cur); syncGuest();
      });
    });

    // suggest (hotel only)
    const q = $('#q'), panel = $('#panel'), hid = $('#hid'), cityId = $('#cityId'), hotelName = $('#hotelName');
    const show = el => el.style.display='block', hide = el => { el.style.display='none'; el.innerHTML=''; };
    const esc = s => String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    let timer=null, aborter=null;

    function row(h){
      const name = h.label || h.hotel_name || h.name || '';
      const city = h.city_name || h.city || '';
      return `<div class="item" data-hid="${esc(h.id||h.hotel_id||'')}" data-city="${esc(h.city_id||'')}" data-name="${esc(name)}">
        <div><div style="font-weight:600">${esc(name)}</div><div class="muted" style="font-size:13px">${esc(city)}</div></div>
        <div class="muted" style="font-size:13px">โรงแรม</div>
      </div>`;
    }

    function bindPanel(){
      panel.querySelectorAll('.item').forEach(el=>{
        el.addEventListener('mousedown', ev=>{
          ev.preventDefault();
          const id = el.getAttribute('data-hid');
          const c  = el.getAttribute('data-city') || '';
          const n  = el.getAttribute('data-name') || '';
          q.value = n;
          hid.value = id;
          cityId.value = c;
          hotelName.value = n;
          hide(panel);
          refreshAgodaLink();
        });
      });
    }

    async function getJson(u){
      try{
        const r = await fetch(u, {cache:'no-store', signal: aborter?.signal});
        return await r.json();
      }catch(_){ return {ok:false,items:[]}; }
    }

    async function suggestHotels(){
      const text = (q.value||'').trim();
      hid.value=''; cityId.value=''; hotelName.value='';
      if (timer) clearTimeout(timer);
      if (!text){ hide(panel); return; }
      panel.innerHTML = `<div class="group">กำลังค้นหา...</div>`; show(panel);
      timer = setTimeout(async ()=>{
        aborter?.abort(); aborter = new AbortController();
        const url = `/api/suggest?q=${encodeURIComponent(text)}&lang=th-th&type=hotel&limit=30`;
        const data = await getJson(url);
        const items = (data && data.ok && Array.isArray(data.items)) ? data.items : [];
        panel.innerHTML = items.length
          ? (`<div class="group">โรงแรม</div>` + items.map(row).join(''))
          : `<div class="item"><div>ไม่พบรายการ</div><div class="muted" style="font-size:13px">ลองพิมพ์ให้ยาวขึ้น</div></div>`;
        show(panel); bindPanel();
      }, 220);
    }

    q.addEventListener('input', suggestHotels);
    document.addEventListener('click', e=>{ if(!panel.contains(e.target) && e.target!==q) hide(panel); });

    // Agoda link (direct)
    function partnerUrl(){
      const lang = 'th-th';
      const base = `https://www.agoda.com/${lang}/partners/partnersearch.aspx`;
      const sp = new URLSearchParams({
        cid:'1949420',
        ...(hid.value ? {hid:String(hid.value)} : {}),
        ...(cityId.value ? {city:String(cityId.value)} : {}),
        checkin: ci.value || '',
        checkout: co.value || '',
        rooms: String(rooms || 1),
        adults: String(adults || 2),
        children: String(children || 0),
        currency: 'THB',
        utm_source:'clickandgo', utm_medium:'affiliate', noapp:'1', pcs:'1'
      });
      return `${base}?${sp.toString()}`;
    }
    function refreshAgodaLink(){ $('#agodaLink').setAttribute('href', partnerUrl()); }
    refreshAgodaLink();

    // submit -> search.html?hid=...
    $('#f').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = hotelName.value || q.value || '';
      if (!hid.value){
        // ยังไม่ได้เลือกจาก suggest → พยายามค้น resolve อัตโนมัติแบบเร็ว ๆ
        const go = new URL('/search.html', location.origin);
        go.searchParams.set('q', name);
        go.searchParams.set('checkin', ci.value);
        go.searchParams.set('checkout', co.value);
        go.searchParams.set('rooms', rooms);
        go.searchParams.set('adults', adults);
        go.searchParams.set('children', children);
        go.searchParams.set('lang', 'th-th');
        location.href = go.toString();
        return;
      }
      const u = new URL('/search.html', location.origin);
      u.searchParams.set('hid', hid.value);
      u.searchParams.set('checkin', ci.value);
      u.searchParams.set('checkout', co.value);
      u.searchParams.set('rooms', rooms);
      u.searchParams.set('adults', adults);
      u.searchParams.set('children', children);
      u.searchParams.set('lang', 'th-th');
      location.href = u.toString();
    });
  })();
  </script>
</body>
</html>
